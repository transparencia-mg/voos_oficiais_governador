<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Voos Oficiais — Governo de Minas Gerais</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Plotly (versão explícita para evitar warning) -->
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <!-- PapaParse para CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --primary-dark:#29435A;
      --accent-red:#B93C42;
      --accent-bright:#DB233F;
      --secondary-green:#2E8B57;
      --background-light:#EEEFF5;
    }
    body{font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background:var(--background-light); padding-bottom:40px;}
    .main-header{background:linear-gradient(135deg,#132837 0%,var(--primary-dark) 100%); color:#fff; padding:22px 0; margin-bottom:20px; border-bottom:4px solid var(--accent-red);}
    .logo{width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(--accent-red),var(--accent-bright));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;}
    .filter-card{background:#fff;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
    .chart-card{background:#fff;border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .table-card{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);overflow:hidden;margin-bottom:18px;}
    .card-stats{background:#fff;border-radius:10px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,0.06);text-align:center}
    .value{font-weight:800;font-size:22px;color:var(--accent-red)}
    .table thead th{background:#f8f9fa}
    .btn-primary-custom{background:linear-gradient(90deg,var(--accent-red),var(--accent-bright));border:none;color:#fff}
    .update-status{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:20px;background:#fff;color:var(--primary-dark)}
    .update-status.online{color:var(--secondary-green);background:rgba(46,139,87,0.06)}
    .loading-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.9);z-index:9999;display:none}
    @media(max-width:992px){ .grid-2{grid-template-columns:1fr!important} }
  </style>
</head>
<body>
  <!-- Loading -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="text-center">
      <div style="width:56px;height:56px;border:6px solid rgba(0,0,0,0.08);border-top-color:var(--accent-red);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px"></div>
      <div id="loadingText">Carregando dados do GitHub...</div>
    </div>
  </div>
  <style>@keyframes spin{100%{transform:rotate(360deg)}}</style>

  <header class="main-header">
    <div class="container d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-3">
        <div class="logo"><i class="fas fa-plane"></i></div>
        <div style="color:#fff">
          <h1 style="margin:0;font-size:20px">Painel de Voos Oficiais</h1>
          <div style="opacity:0.9;font-size:13px">Governo do Estado de Minas Gerais — Transparência</div>
        </div>
      </div>
      <div>
        <div id="updateStatus" class="update-status">
          <i class="fas fa-circle"></i><span id="updateStatusText">Preparando</span>
        </div>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- filtros -->
    <div class="filter-card">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label small">Ano</label>
          <select id="filter-ano" class="form-select"><option value="2025">2025</option><option value="2021">2021</option><option value="all">Todos</option></select>
        </div>
        <div class="col-md-3">
          <label class="form-label small">Origem</label>
          <select id="filter-origem" class="form-select"><option value="all">Todas as origens</option></select>
        </div>
        <div class="col-md-3">
          <label class="form-label small">Destino</label>
          <select id="filter-destino" class="form-select"><option value="all">Todos os destinos</option></select>
        </div>
        <div class="col-md-3">
          <label class="form-label small">Passageiro</label>
          <select id="filter-passageiro" class="form-select"><option value="all">Todos os passageiros</option></select>
        </div>
        <div class="col-12 d-flex gap-2 mt-2">
          <button class="btn btn-primary btn-primary-custom" id="btn-apply"><i class="fas fa-filter me-2"></i>Aplicar</button>
          <button class="btn btn-outline-secondary" id="btn-clear"><i class="fas fa-redo me-2"></i>Limpar</button>
        </div>
      </div>
    </div>

    <!-- cards -->
    <div class="row g-3 mb-3">
      <div class="col-md-3"><div class="card-stats"><div style="font-size:12px;color:#666">Total de Voos</div><div class="value" id="card-voos">—</div></div></div>
      <div class="col-md-3"><div class="card-stats"><div style="font-size:12px;color:#666">Horas Voadas</div><div class="value" id="card-horas">—</div></div></div>
      <div class="col-md-3"><div class="card-stats"><div style="font-size:12px;color:#666">Passageiros</div><div class="value" id="card-passageiros">—</div></div></div>
      <div class="col-md-3"><div class="card-stats"><div style="font-size:12px;color:#666">Destinos Únicos</div><div class="value" id="card-destinos">—</div></div></div>
    </div>

    <!-- charts -->
    <div class="row g-3 grid-2" style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="chart-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 style="margin:0">Destinos (pizza)</h5>
          <small class="text-muted">Fonte: GitHub</small>
        </div>
        <div id="chart-pizza" style="height:320px"></div>
      </div>
      <div class="chart-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 style="margin:0">Distribuição por Mês (barras)</h5>
          <small class="text-muted">Fonte: GitHub</small>
        </div>
        <div id="chart-meses" style="height:320px"></div>
      </div>
    </div>

    <!-- tabela detalhamento de voos (agregada por voo) -->
    <div class="table-card mt-3">
      <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
        <div>
          <h5 style="margin:0">Detalhamento de Voos (1 linha por voo)</h5>
          <small class="text-muted">Campos: data, n_db, origem, destino, quantidade de passageiros, horas_voadas</small>
        </div>
        <div class="d-flex gap-2 align-items-center">
          <span class="badge bg-success" id="voos-count">0 voos</span>
          <button class="btn btn-outline-primary btn-sm" id="exportCSV">Exportar CSV</button>
        </div>
      </div>
      <div class="table-responsive p-3">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Data</th>
              <th>Voo (n_db)</th>
              <th>Origem</th>
              <th>Destino</th>
              <th>Qtd Passageiros</th>
              <th>Horas Voadas</th>
            </tr>
          </thead>
          <tbody id="voos-table-body">
            <tr><td colspan="6" class="text-center">Carregando...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="p-3 border-top d-flex justify-content-between align-items-center">
        <div id="pagination-info">Mostrando 0 de 0 voos</div>
        <div class="d-flex gap-2">
          <button id="btn-prev" class="btn btn-sm btn-outline-primary" disabled>Anterior</button>
          <button id="btn-next" class="btn btn-sm btn-outline-primary" disabled>Próximo</button>
        </div>
      </div>
    </div>

    <!-- analise por destino -->
    <div class="table-card">
      <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
        <div>
          <h5 style="margin:0">Análise por Destino</h5>
          <small class="text-muted">Filtros: ano, destino, passageiro</small>
        </div>
        <div>
          <select id="analise-ano" class="form-select form-select-sm"></select>
        </div>
      </div>

      <div class="p-3">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label small">Destino</label>
            <select id="analise-destino" class="form-select"><option value="all">Todos</option></select>
          </div>
          <div class="col-md-4">
            <label class="form-label small">Passageiro</label>
            <select id="analise-passageiro" class="form-select"><option value="all">Todos</option></select>
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button id="btn-analisar" class="btn btn-primary">Gerar Análise</button>
          </div>
        </div>

        <div class="mt-3">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Destino</th>
                  <th>Total de Voos</th>
                  <th>Horas Totais</th>
                  <th>Quantidade de Passageiros</th>
                  <th>Percentual de Voos (%)</th>
                </tr>
              </thead>
              <tbody id="analise-table-body">
                <tr><td colspan="5" class="text-center">Selecione filtros e clique em "Gerar Análise"</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- arquivos -->
    <div class="table-card p-3">
      <h5>Arquivos no GitHub</h5>
      <div id="arquivos-lista" class="list-group"></div>
    </div>

  </main>

  <footer class="text-center p-3" style="color:#666;margin-top:30px">
    Dados do repositório <a href="https://github.com/transparencia-mg/voos_oficiais_governador" target="_blank">transparencia-mg/voos_oficiais_governador</a>
  </footer>

  <!-- Script -->
  <script>
  (function(){
    // CONFIG
    const GITHUB_REPO = 'transparencia-mg/voos_oficiais_governador';
    const GITHUB_RAW = 'https://raw.githubusercontent.com';
    const DATA_PATH = 'docs/data/normalized';
    const FILES = ['voos_2025.csv','voos_2021.csv']; // prioridade 2025
    const PAGE_SIZE = 50;

    // Estado
    let rawRows = [];           // todas as linhas do CSV (cada linha = 1 passageiro)
    let flightsAgg = [];        // voos agregados (1 linha por vooKey)
    let filteredFlights = [];   // voos após filtros
    let currentPage = 1;

    // Paleta de cores (harmonizada com visual)
    const palette = [
      '#DB233F','#B93C42','#6A5ACD','#2E5984','#2E8B57','#F39C12','#E67E22','#5DADE2','#48C9B0','#AF7AC5',
      '#D35400','#1F618D','#117A65','#7D3C98','#A93226','#2C3E50'
    ];

    // Util: limpar BOM e normalizar cabeçalho
    function limparBOM(s){ return s ? s.replace(/^\uFEFF/,'') : s; }
    function normalizeKey(k){
      if(!k) return '';
      k = limparBOM(String(k)).trim();
      k = k.normalize('NFD').replace(/[\u0300-\u036f]/g,''); // remove acentos
      k = k.replace(/[^\w]+/g,'_').replace(/^_|_$/g,'').toLowerCase();
      return k;
    }

    // Parser com PapaParse usando transformHeader
    function parseCSV(csvText){
      return new Promise((resolve, reject) => {
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          transformHeader: h => normalizeKey(h),
          complete: results => resolve(results.data),
          error: err => reject(err)
        });
      });
    }

    // Formata horas decimais -> "Hh Mm"
    function formatHorasDecimais(h){
      const val = parseFloat(h) || 0;
      const horas = Math.floor(val);
      const minutos = Math.round((val - horas) * 60);
      return `${horas}h${minutos>0? ' ' + minutos + 'm' : ''}`;
    }

    // Formata data para dd/mm/yyyy quando possível
    function formatDate(d){
      if(!d) return '';
      const dt = new Date(d);
      if(!isNaN(dt.getTime())) return dt.toLocaleDateString('pt-BR');
      const m = String(d).match(/^(\d{4})-(\d{2})-(\d{2})/);
      if(m) return `${m[3]}/${m[2]}/${m[1]}`;
      return d;
    }

    // Gera uma chave de voo única: data|n_db|origem|destino
    function flightKey(row){
      return `${(row.data||'').trim()}|${(row.n_db||'').toString().trim()}|${(row.origem||'').toString().trim()}|${(row.destino||'').toString().trim()}`;
    }

    // Carrega todos os arquivos listados em FILES
    async function loadAll(){
      showLoading('Carregando arquivos...');
      updateStatus('updating','Carregando dados do GitHub...');
      rawRows = [];
      for(const fname of FILES){
        const url = `${GITHUB_RAW}/${GITHUB_REPO}/main/${DATA_PATH}/${fname}`;
        try{
          const res = await fetch(url);
          if(!res.ok){ console.warn('Arquivo não encontrado', url, res.status); continue; }
          const text = await res.text();
          const parsed = await parseCSV(text);
          // já normalizado por transformHeader; garantir nomes esperados
          // map minimal: keep original keys (normalized)
          parsed.forEach(row => {
            // ensure properties exist and normalized names:
            // We expect: historico, solicitante, orgao_solicitante, situacao_voo, horas_voadas,
            // aeronave, n_db, base, data, orgao_responsavel, origem, destino, passageiro, cargo_funcao, orgao_passageiro
            rawRows.push(row);
          });
        }catch(err){
          console.error('Erro ao ler arquivo', fname, err);
        }
      }

      // Normalize each raw row to canonical keys (fallbacks)
      rawRows = rawRows.map(r => {
        const map = {};
        // use normalized keys (they are already normalized by PapaParse header transform)
        map.historico = r.historico || r.historico_ || '';
        map.solicitante = r.solicitante || '';
        map.orgao_solicitante = r.orgao_solicitante || r.orgao_solicitante_ || '';
        map.situacao_voo = (r.situacao_voo || r.situacao || r.status_voo || '').toString().trim();
        // horas_voadas might be stored with comma
        const hv = (r.horas_voadas !== undefined && r.horas_voadas !== null) ? String(r.horas_voadas).replace(',', '.') : r.horas_voadas;
        map.horas_voadas = (hv === '' || hv === null || hv === undefined) ? 0 : parseFloat(hv) || 0;
        map.aeronave = r.aeronave || '';
        map.n_db = r.n_db || r.n_db_ || r.numero_voo || '';
        map.base = r.base || '';
        map.data = r.data || r.date || '';
        map.orgao_responsavel = r.orgao_responsavel || '';
        map.origem = (r.origem || r.origin || '').toString().trim();
        map.destino = (r.destino || r.destination || '').toString().trim();
        map.passageiro = (r.passageiro || r.passageiro_ || '').toString().trim();
        map.cargo_funcao = r.cargo_funcao || r.cargo_funcao_ || '';
        map.orgao_passageiro = r.orgao_passageiro || '';
        // year (try extract)
        const m = String(map.data).match(/(\d{4})/);
        map.ano = m ? m[1] : '';
        return map;
      });

      // Build aggregated flights (1 per unique flightKey)
      buildFlightsAggregate();

      // Fill UI controls and render
      populateFilters();
      renderAll();

      hideLoading();
      updateStatus('online','Dados carregados');
    }

    // Agrupa rawRows por flightKey e cria flightsAgg array
    function buildFlightsAggregate(){
      const map = new Map(); // key -> {key, data (first), n_db, origem, destino, horas_voadas (one value), passageiros:Set, linhasCount}
      rawRows.forEach(r => {
        // ignore rows missing required fields data/origem/destino
        if(!r.data || !r.origem || !r.destino) return;
        const key = flightKey(r);
        if(!map.has(key)){
          map.set(key, {
            key,
            data: r.data,
            n_db: r.n_db || '',
            origem: r.origem || '',
            destino: r.destino || '',
            horas_voadas: parseFloat(r.horas_voadas || 0) || 0,
            passageiros: new Set(),
            linhas: []
          });
        }
        const rec = map.get(key);
        if(r.passageiro) rec.passageiros.add(r.passageiro);
        rec.linhas.push(r);
        // If horas_voadas is 0 and some lines have value, prefer non-zero (defensive)
        const hv = parseFloat(r.horas_voadas || 0) || 0;
        if(hv > 0 && (!rec.horas_voadas || rec.horas_voadas === 0)) rec.horas_voadas = hv;
        // store ano if missing
        if(!rec.ano){ const m = String(r.data).match(/(\d{4})/); rec.ano = m ? m[1] : r.ano || ''; }
        else rec.ano = rec.ano || (String(r.data).match(/(\d{4})/)||[])[1] || '';
      });

      flightsAgg = Array.from(map.values()).map(f => {
        return {
          key: f.key,
          data: f.data,
          n_db: f.n_db,
          origem: f.origem,
          destino: f.destino,
          horas_voadas: parseFloat(f.horas_voadas || 0) || 0,
          passageiros_count: f.passageiros.size,
          passageiros_list: Array.from(f.passageiros),
          linhas: f.linhas,
          ano: (String(f.data).match(/(\d{4})/) || [])[1] || ''
        };
      });

      // default sort: data desc
      flightsAgg.sort((a,b) => (b.data||'').localeCompare(a.data||''));
    }

    // Popula selects (anos, origens, destinos, passageiros)
    function populateFilters(){
      const anos = Array.from(new Set(flightsAgg.map(f=>f.ano).filter(Boolean))).sort().reverse();
      const origins = Array.from(new Set(flightsAgg.map(f=>f.origem).filter(Boolean))).sort();
      const destinos = Array.from(new Set(flightsAgg.map(f=>f.destino).filter(Boolean))).sort();
      const passageiros = Array.from(new Set(rawRows.map(r=>r.passageiro).filter(Boolean))).sort();

      const sAno = document.getElementById('filter-ano'), sOrig = document.getElementById('filter-origem'), sDest = document.getElementById('filter-destino'), sPass = document.getElementById('filter-passageiro');
      const aAno = document.getElementById('analise-ano'), aDest = document.getElementById('analise-destino'), aPass = document.getElementById('analise-passageiro');

      // fill anos
      sAno.innerHTML = '';
      aAno.innerHTML = '';
      anos.forEach(y => { sAno.appendChild(new Option(y,y)); aAno.appendChild(new Option(y,y)); });
      sAno.appendChild(new Option('Todos','all'));
      aAno.appendChild(new Option('Todos','all'));
      // set default
      if(anos.includes('2025')) sAno.value='2025';
      if(anos.includes('2025')) aAno.value='2025';

      // origem
      sOrig.innerHTML = '<option value="all">Todas as origens</option>';
      origins.forEach(o => sOrig.appendChild(new Option(o,o)));
      // destino
      sDest.innerHTML = '<option value="all">Todos os destinos</option>';
      aDest.innerHTML = '<option value="all">Todos</option>';
      destinos.forEach(d => { sDest.appendChild(new Option(d,d)); aDest.appendChild(new Option(d,d)); });
      // passageiro
      sPass.innerHTML = '<option value="all">Todos os passageiros</option>';
      aPass.innerHTML = '<option value="all">Todos</option>';
      passageiros.forEach(p => { sPass.appendChild(new Option(p,p)); aPass.appendChild(new Option(p,p)); });

      // arquivos list
      const arquivos = document.getElementById('arquivos-lista');
      arquivos.innerHTML = '';
      FILES.forEach(f => {
        const url = `${GITHUB_RAW}/${GITHUB_REPO}/main/${DATA_PATH}/${f}`;
        const item = document.createElement('div'); item.className = 'list-group-item d-flex justify-content-between align-items-center';
        item.innerHTML = `<div><strong>${f}</strong><div class="small text-muted">Arquivo CSV</div></div><div><a class="btn btn-sm btn-outline-primary" href="${url}" target="_blank"><i class="fas fa-download"></i> Baixar</a></div>`;
        arquivos.appendChild(item);
      });
    }

    // Render geral: aplica filtros e atualiza cartões, tabelas e gráficos
    function renderAll(){
      applyFilters(); // will call subsequent updates
    }

    // Apply filters to flightsAgg producing filteredFlights
    function applyFilters(){
      const ano = document.getElementById('filter-ano').value;
      const origem = document.getElementById('filter-origem').value;
      const destino = document.getElementById('filter-destino').value;
      const passageiro = document.getElementById('filter-passageiro').value;

      filteredFlights = flightsAgg.filter(f => {
        if(ano && ano !== 'all' && String(f.ano) !== String(ano)) return false;
        if(origem && origem !== 'all' && f.origem !== origem) return false;
        if(destino && destino !== 'all' && f.destino !== destino) return false;
        if(passageiro && passageiro !== 'all'){
          // passageiro filter: check if passenger present in flight lines
          return f.passageiros_list.includes(passageiro);
        }
        return true;
      });

      // sort by date descending
      filteredFlights.sort((a,b) => (b.data||'').localeCompare(a.data||''));

      currentPage = 1;
      updateCards();
      updateTable();
      updateCharts();
      updatePagination();
    }

    // Update summary cards
    function updateCards(){
      const totalFlightsUnique = filteredFlights.length;
      // sum horas from flightsAgg (each flight counted once)
      const totalHoras = filteredFlights.reduce((s,f)=> s + (parseFloat(f.horas_voadas||0)||0), 0);
      // count unique passengers across filtered flights based on rawRows within those flights
      const passSet = new Set();
      filteredFlights.forEach(f => {
        (f.passageiros_list||[]).forEach(p => passSet.add(p));
      });
      const totalPassengers = passSet.size;
      const uniqueDestCount = new Set(filteredFlights.map(f=>f.destino)).size;

      document.getElementById('card-voos').textContent = totalFlightsUnique.toLocaleString('pt-BR');
      document.getElementById('card-horas').textContent = formatHorasDecimais(totalHoras);
      document.getElementById('card-passageiros').textContent = totalPassengers.toLocaleString('pt-BR');
      document.getElementById('card-destinos').textContent = uniqueDestCount.toLocaleString('pt-BR');
      document.getElementById('voos-count').textContent = `${totalFlightsUnique} voos`;
    }

    // Update aggregated flights table (paginated)
    function updateTable(){
      const tbody = document.getElementById('voos-table-body');
      const start = (currentPage-1) * PAGE_SIZE;
      const page = filteredFlights.slice(start, start + PAGE_SIZE);
      if(page.length === 0){
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum voo encontrado com os filtros aplicados</td></tr>';
        return;
      }
      let html = '';
      page.forEach(f => {
        html += `<tr>
          <td>${formatDate(f.data)}</td>
          <td>${escapeHtml(f.n_db || '')}</td>
          <td>${escapeHtml(f.origem)}</td>
          <td>${escapeHtml(f.destino)}</td>
          <td>${(f.passageiros_count || f.passageiros_count === 0) ? f.passageiros_count : (f.passageiros_list.length)}</td>
          <td>${formatHorasDecimais(f.horas_voadas)}</td>
        </tr>`;
      });
      tbody.innerHTML = html;
      document.getElementById('voos-count').textContent = `${filteredFlights.length} voos`;
    }

    // Update pagination text and buttons
    function updatePagination(){
      const total = filteredFlights.length;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      const startItem = total === 0 ? 0 : (currentPage-1)*PAGE_SIZE + 1;
      const endItem = Math.min(currentPage*PAGE_SIZE, total);
      document.getElementById('pagination-info').textContent = `Mostrando ${startItem}-${endItem} de ${total} voos`;
      document.getElementById('btn-prev').disabled = currentPage <= 1;
      document.getElementById('btn-next').disabled = currentPage >= totalPages;
    }

    // Next/Prev page
    document.getElementById('btn-prev').addEventListener('click', ()=> { if(currentPage>1){ currentPage--; updateTable(); updatePagination(); }});
    document.getElementById('btn-next').addEventListener('click', ()=> { const totalPages = Math.max(1, Math.ceil(filteredFlights.length / PAGE_SIZE)); if(currentPage<totalPages){ currentPage++; updateTable(); updatePagination(); }});

    // Charts: pizza for destinations (ALL destinations) and bar for months
    function updateCharts(){
      // Pizza: all destinations counts (based on filteredFlights)
      const destCounts = {};
      filteredFlights.forEach(f => {
        const d = f.destino || 'Não informado';
        destCounts[d] = (destCounts[d] || 0) + 1;
      });
      const destLabels = Object.keys(destCounts);
      const destValues = destLabels.map(l => destCounts[l]);

      // use palette repeat if needed
      const colorsPizza = destLabels.map((_,i) => palette[i % palette.length]);

      const pieTrace = {
        labels: destLabels,
        values: destValues,
        type: 'pie',
        marker: { colors: colorsPizza },
        textinfo: 'label+percent',
        hoverinfo: 'label+value+percent',
        automargin: true
      };
      Plotly.newPlot('chart-pizza', [pieTrace], {paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)', margin:{t:10,l:10,r:10,b:10}});

      // Bars per month: we need counts by month across flights (use flight.data)
      const months = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
      const monthCounts = Array(12).fill(0);
      filteredFlights.forEach(f => {
        // try to parse month from date
        const dt = new Date(f.data);
        if(!isNaN(dt.getTime())){
          monthCounts[dt.getMonth()] += 1;
        } else {
          // try YYYY-MM-DD parse
          const m = String(f.data).match(/^(\d{4})-(\d{2})-(\d{2})/);
          if(m){ monthCounts[parseInt(m[2],10)-1] += 1; }
        }
      });

      const barColors = months.map((_,i) => palette[i % palette.length]);

      const barTrace = {
        x: months,
        y: monthCounts,
        type: 'bar',
        marker: { color: barColors }
      };
      Plotly.newPlot('chart-meses', [barTrace], {paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)', margin:{t:10,l:40,b:40}});
    }

    // Análise por destino: calcula voos únicos por destino (respect flight uniqueness)
    document.getElementById('btn-analisar').addEventListener('click', gerarAnalise);

    function gerarAnalise(){
      const ano = document.getElementById('analise-ano').value;
      const destinoFilter = document.getElementById('analise-destino').value;
      const passageiroFilter = document.getElementById('analise-passageiro').value;

      // filter flights (but need to consider unique flights per destination)
      let arr = flightsAgg.slice();
      if(ano && ano !== 'all') arr = arr.filter(f => String(f.ano) === String(ano));
      if(destinoFilter && destinoFilter !== 'all') arr = arr.filter(f => f.destino === destinoFilter);
      if(passageiroFilter && passageiroFilter !== 'all') arr = arr.filter(f => f.passageiros_list.includes(passageiroFilter));

      // map by destino
      const map = {};
      arr.forEach(f => {
        const dest = f.destino || 'Não informado';
        if(!map[dest]) map[dest] = { destino: dest, voos_set: new Set(), horas: 0, passageiros_count: 0, passageirosSet: new Set() };
        // each flight is unique already in flightsAgg, so count as one flight
        map[dest].voos_set.add(f.key);
        map[dest].horas += parseFloat(f.horas_voadas || 0) || 0;
        // passageiros_count is sum of passenger rows (each passenger is one row), we have passageiros_list
        (f.passageiros_list || []).forEach(p => { map[dest].passageirosSet.add(p); });
      });

      const arrRes = Object.values(map).map(v => ({
        destino: v.destino,
        total_voos: v.voos_set.size,
        horas_totais: v.horas,
        quantidade_passageiros: v.passageirosSet.size
      })).sort((a,b) => b.total_voos - a.total_voos);

      // compute percent: for each destino, percentual = total_voos / sum(total_voos) * 100
      const totalVoosAll = arrRes.reduce((s,i) => s + i.total_voos, 0) || 0;
      const tbody = document.getElementById('analise-table-body');
      if(arrRes.length === 0){
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum dado</td></tr>';
        document.getElementById('analise-total').textContent = '0';
        document.getElementById('analise-horas').textContent = '—';
        document.getElementById('analise-passageiros').textContent = '0';
        document.getElementById('analise-sucesso').textContent = '—';
        return;
      }

      let html = '';
      arrRes.forEach(r => {
        const perc = totalVoosAll ? ((r.total_voos / totalVoosAll) * 100).toFixed(1) : '0.0';
        html += `<tr>
          <td>${escapeHtml(r.destino)}</td>
          <td>${r.total_voos.toLocaleString('pt-BR')}</td>
          <td>${formatHorasDecimais(r.horas_totais)}</td>
          <td>${r.quantidade_passageiros.toLocaleString('pt-BR')}</td>
          <td>${perc}%</td>
        </tr>`;
      });
      tbody.innerHTML = html;

      // totals
      const totalHoras = arrRes.reduce((s,i) => s + (parseFloat(i.horas_totais)||0), 0);
      const totalPassengers = arrRes.reduce((s,i) => s + (i.quantidade_passageiros||0), 0);
      const totalVoos = arrRes.reduce((s,i) => s + (i.total_voos||0), 0);

      document.getElementById('analise-total').textContent = totalVoos.toLocaleString('pt-BR');
      document.getElementById('analise-horas').textContent = formatHorasDecimais(totalHoras);
      document.getElementById('analise-passageiros').textContent = totalPassengers.toLocaleString('pt-BR');
      document.getElementById('analise-sucesso').textContent = '—';
    }

    // Helpers
    function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // Export CSV of filteredFlights (one line per aggregated flight)
    function exportCSV(){
      if(!filteredFlights || filteredFlights.length === 0){ alert('Nenhum dado para exportar'); return; }
      const headers = ['data','n_db','origem','destino','qtd_passageiros','horas_voadas'];
      const rows = [headers.join(',')];
      filteredFlights.forEach(f => {
        const r = [f.data, f.n_db, f.origem, f.destino, f.passageiros_list.length, (f.horas_voadas||0)];
        rows.push(r.map(cell => {
          const s = (cell===null||cell===undefined)?'':String(cell);
          return (s.includes(',')||s.includes('"'))? `"${s.replace(/"/g,'""')}"` : s;
        }).join(','));
      });
      const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a'); link.href = URL.createObjectURL(blob);
      link.download = `voos_agregados_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(link); link.click(); link.remove();
      URL.revokeObjectURL(link.href);
    }
    document.getElementById('exportCSV').addEventListener('click', exportCSV);

    // UI bindings
    document.getElementById('btn-apply').addEventListener('click', applyFilters);
    document.getElementById('btn-clear').addEventListener('click', () => {
      document.getElementById('filter-ano').value = '2025';
      document.getElementById('filter-origem').value = 'all';
      document.getElementById('filter-destino').value = 'all';
      document.getElementById('filter-passageiro').value = 'all';
      applyFilters();
    });

    // show/hide loading and status
    function showLoading(text='Carregando...'){ document.getElementById('loadingText').textContent = text; document.getElementById('loadingOverlay').style.display = 'flex'; }
    function hideLoading(){ document.getElementById('loadingOverlay').style.display = 'none'; }
    function updateStatus(cls, text){ const el = document.getElementById('updateStatus'); const t = document.getElementById('updateStatusText'); el.className = 'update-status ' + cls; t.textContent = text; }

    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
      loadAll().catch(err => {
        console.error('Erro inicial', err);
        hideLoading();
        updateStatus('offline','Erro ao carregar');
      });
    });

    // Expose small debug to window for console if needed
    window.__voos_debug = () => ({ rawRows, flightsAgg, filteredFlights });

  })();
  </script>
</body>
</html>
