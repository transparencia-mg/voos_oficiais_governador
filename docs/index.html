<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Voos Oficiais — Governo de Minas Gerais</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <!-- Plotly (versão explícita) -->
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <!-- Tippy.js para tooltips -->
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <!-- PapaParse para CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --primary-dark:#29435A;
      --primary-darker:#132837;
      --accent-red:#B93C42;
      --accent-bright:#DB233F;
      --background-light:#EEEFF5;
      --secondary-green:#2E8B57;
      --palette-1:#29435A;
      --palette-2:#2E5984;
      --palette-3:#6A5ACD;
      --palette-4:#2E8B57;
      --palette-5:#DB233F;
      --palette-6:#E58A6E;
      --palette-7:#4F9EC4;
      --palette-8:#98D1C2;
    }
    body{font-family:Segoe UI, Tahoma, Arial, sans-serif;background:var(--background-light);padding-bottom:40px;}
    .main-header{background:linear-gradient(135deg,var(--primary-darker) 0%,var(--primary-dark) 100%);color:#fff;padding:22px 0;margin-bottom:24px;border-bottom:4px solid var(--accent-red);box-shadow:0 6px 20px rgba(0,0,0,0.12)}
    .logo{width:68px;height:68px;border-radius:50%;background:linear-gradient(135deg,var(--accent-red),var(--accent-bright));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:22px;box-shadow:0 6px 18px rgba(0,0,0,0.12)}
    .header-title{font-size:26px;margin:0;font-weight:800}
    .header-subtitle{font-size:14px;opacity:0.9;margin-top:6px}
    .filter-container{background:#fff;border-radius:12px;padding:18px;margin-bottom:18px;box-shadow:0 4px 18px rgba(0,0,0,0.06);border-left:5px solid var(--accent-red)}
    .chart-container{background:#fff;border-radius:12px;padding:14px;box-shadow:0 4px 18px rgba(0,0,0,0.06);min-height:220px}
    .card-stats{background:#fff;border-radius:12px;padding:16px;box-shadow:0 4px 10px rgba(0,0,0,0.06);text-align:center}
    .card-stats .value{font-weight:800;font-size:22px;color:var(--accent-red)}
    .table-container{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 18px rgba(0,0,0,0.06)}
    .table-header{background:linear-gradient(135deg,var(--primary-dark),var(--primary-darker));color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
    .table-badge{background:var(--accent-red);color:#fff;padding:6px 12px;border-radius:18px;font-weight:700}
    .btn-primary-custom{background:linear-gradient(90deg,var(--accent-red),var(--accent-bright));border:none;color:#fff;padding:10px 16px;border-radius:8px}
    .btn-secondary-custom{background:#fff;border:2px solid var(--primary-dark);color:var(--primary-dark);padding:8px 14px;border-radius:8px}
    .update-status{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:20px;background:rgba(255,255,255,0.9);color:var(--primary-dark)}
    .update-status.online{color:var(--secondary-green);background:rgba(46,139,87,0.08)}
    .loading-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.85);z-index:9999;display:none}
    @media (max-width:992px){.row.g-3>.col-md-3{margin-bottom:10px}}
  </style>
</head>
<body>
  <!-- Loading -->
  <div id="loadingOverlay" class="loading-overlay">
    <div style="display:flex;gap:12px;align-items:center">
      <div style="width:48px;height:48px;border:5px solid rgba(0,0,0,0.08);border-top-color:var(--accent-red);border-radius:50%;animation:spin 1s linear infinite"></div>
      <div><strong id="loadingText">Carregando dados do GitHub...</strong></div>
    </div>
  </div>
  <style>@keyframes spin{100%{transform:rotate(360deg)}}</style>

  <!-- Header -->
  <header class="main-header">
    <div class="container d-flex justify-content-between align-items-center">
      <div style="display:flex;gap:16px;align-items:center">
        <div class="logo"><i class="fas fa-plane"></i></div>
        <div>
          <div class="header-title">Painel de Voos Oficiais</div>
          <div class="header-subtitle">Governo do Estado de Minas Gerais — Transparência de Voos Oficiais</div>
        </div>
      </div>
      <div><div id="updateStatus" class="update-status"><i class="fas fa-circle"></i> <span id="updateStatusText">Iniciando</span></div></div>
    </div>
  </header>

  <!-- Main -->
  <main class="container">
    <!-- Tabs (kept simple) -->
    <div class="mb-3">
      <ul class="nav nav-tabs" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation"><button class="nav-link active" data-target="#tab-overview" type="button">Visão Geral</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" data-target="#tab-destinos" type="button">Análise por Destino</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" data-target="#tab-download" type="button">Download de Dados</button></li>
      </ul>
    </div>

    <!-- VISÃO GERAL -->
    <section id="tab-overview" class="tab-pane active">
      <div class="filter-container">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Ano</label>
            <select id="filter-ano" class="form-select"><option value="all">Carregando...</option></select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Origem</label>
            <select id="filter-origem" class="form-select"><option value="all">Todas as origens</option></select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Destino</label>
            <select id="filter-destino" class="form-select"><option value="all">Todos os destinos</option></select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Passageiro</label>
            <select id="filter-passageiro" class="form-select"><option value="all">Todos</option></select>
          </div>
        </div>
        <div class="mt-3 d-flex gap-2">
          <button id="btn-apply" class="btn-primary-custom"><i class="fas fa-filter me-2"></i> Aplicar Filtros</button>
          <button id="btn-clear" class="btn-secondary-custom"><i class="fas fa-redo me-2"></i> Limpar Filtros</button>
        </div>
      </div>

      <!-- stats -->
      <div class="row g-3 mb-3">
        <div class="col-md-3"><div class="card-stats"><i class="fas fa-plane fa-2x" style="color:var(--accent-red)"></i><div class="value" id="card-voos">—</div><div class="small">Total de Voos</div></div></div>
        <div class="col-md-3"><div class="card-stats"><i class="fas fa-clock fa-2x" style="color:var(--palette-2)"></i><div class="value" id="card-horas">—</div><div class="small">Horas Voadas</div></div></div>
        <div class="col-md-3"><div class="card-stats"><i class="fas fa-users fa-2x" style="color:var(--secondary-green)"></i><div class="value" id="card-passageiros">—</div><div class="small">Passageiros Únicos</div></div></div>
        <div class="col-md-3"><div class="card-stats"><i class="fas fa-map-marker-alt fa-2x" style="color:var(--palette-3)"></i><div class="value" id="card-destinos">—</div><div class="small">Destinos Únicos</div></div></div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <div class="chart-container">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <strong>Distribuição por Destinos (pizza)</strong>
              <small class="text-muted">Top 10 destinos</small>
            </div>
            <div id="chart-destino-pie" style="width:100%;height:260px;"></div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="chart-container">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <strong>Distribuição por Mês (barras)</strong>
              <small class="text-muted">Mês / número de voos</small>
            </div>
            <div id="chart-mes-bar" style="width:100%;height:260px;"></div>
          </div>
        </div>
      </div>

      <div class="table-container mb-4">
        <div class="table-header">
          <div><strong>Detalhamento de Voos</strong></div>
          <div class="d-flex align-items-center gap-2">
            <span style="background:linear-gradient(90deg,var(--secondary-green),#2e8b47);color:#fff;padding:6px 12px;border-radius:18px;font-weight:700">Ano: <span id="table-year">—</span></span>
            <span class="table-badge" id="voos-count">0 voos</span>
          </div>
        </div>
        <div class="table-responsive p-3">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th>Data</th>
                <th>n_db</th>
                <th>Origem</th>
                <th>Destino</th>
                <th>Qtd. Passageiros</th>
                <th>Situação do Voo</th>
                <th>Horas Voadas</th>
              </tr>
            </thead>
            <tbody id="voos-table-body"><tr><td colspan="7" class="text-center">Carregando...</td></tr></tbody>
          </table>
        </div>
        <div class="p-3 d-flex justify-content-between align-items-center border-top">
          <div id="pagination-info" class="text-muted">Mostrando 0 de 0 voos</div>
          <div class="d-flex gap-2">
            <button id="btn-prev" class="btn btn-sm btn-outline-primary" disabled>Anterior</button>
            <button id="btn-next" class="btn btn-sm btn-outline-primary" disabled>Próximo</button>
          </div>
        </div>
      </div>
    </section>

    <!-- DESTINOS -->
    <section id="tab-destinos" class="tab-pane" style="display:none">
      <div class="filter-container">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Ano</label>
            <select id="analise-ano" class="form-select"></select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Destino</label>
            <select id="analise-destino" class="form-select"><option value="all">Todos os destinos</option></select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Passageiro</label>
            <select id="analise-passageiro" class="form-select"><option value="all">Todos</option></select>
          </div>
        </div>
        <div class="mt-3"><button id="btn-analisar" class="btn-primary-custom"><i class="fas fa-chart-bar me-2"></i>Gerar Análise</button></div>
      </div>

      <div class="card-stats-grid mb-3 row g-3">
        <div class="col-md-3"><div class="card-stats"><i class="fas fa-plane fa-2x" style="color:var(--accent-red)"></i><div class="value" id="analise-total">—</div><div class="small">Voos (únicos)</div></div></div>
        <div class="col-md-3"><div class="card-stats"><i class="fas fa-percentage fa-2x" style="color:var(--secondary-green)"></i><div class="value" id="analise-sucesso">—</div><div class="small">Taxa de Realização</div></div></div>
        <div class="col-md-3"><div class="card-stats"><i class="fas fa-clock fa-2x" style="color:var(--palette-2)"></i><div class="value" id="analise-horas">—</div><div class="small">Horas Totais</div></div></div>
        <div class="col-md-3"><div class="card-stats"><i class="fas fa-users fa-2x" style="color:var(--palette-3)"></i><div class="value" id="analise-passageiros">—</div><div class="small">Passageiros Únicos</div></div></div>
      </div>

      <div class="table-container">
        <div class="table-header"><strong>Resumo por Destino</strong><div></div></div>
        <div class="table-responsive p-3">
          <table class="table table-hover mb-0">
            <thead>
              <tr><th>Destino</th><th>Total de Voos</th><th>Horas Totais</th><th>Qtd. Passageiros</th><th>Percentual de Voos</th></tr>
            </thead>
            <tbody id="analise-table-body"><tr><td colspan="5" class="text-center">Selecione filtros e clique em "Gerar Análise"</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- DOWNLOAD -->
    <section id="tab-download" class="tab-pane" style="display:none">
      <div class="table-container p-4">
        <div class="table-header"><strong>DataSet Completo</strong><div><span class="table-badge">Dados Abertos</span></div></div>
        <div class="p-3">
          <div class="row">
            <div class="col-md-6">
              <h5>Arquivos encontrados (GitHub)</h5>
              <div id="arquivos-lista" class="list-group"></div>
            </div>
            <div class="col-md-6">
              <h5>Exportar dados filtrados</h5>
              <p class="text-muted">Baixe os dados atualmente filtrados</p>
              <div class="d-grid">
                <button id="exportCSV" class="btn btn-outline-primary"><i class="fas fa-file-csv me-2"></i>Exportar CSV</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <footer class="text-center mt-4 mb-4">
    <div class="container">
      <p><i class="fas fa-database"></i> Dados do <a href="https://github.com/transparencia-mg/voos_oficiais_governador" target="_blank">GitHub / transparencia-mg</a></p>
      <p style="font-size:0.85rem;">© Governo de Minas Gerais — Painel de Voos Oficiais</p>
    </div>
  </footer>

  <!-- SCRIPTS -->
  <script>
  // ----------------------------
  // Configurações
  // ----------------------------
  const GITHUB_API_CONTENTS = 'https://api.github.com/repos/transparencia-mg/voos_oficiais_governador/contents/docs/data/normalized';
  const GITHUB_RAW_BASE = 'https://raw.githubusercontent.com/transparencia-mg/voos_oficiais_governador/main/docs/data/normalized';
  const FILENAME_REGEX = /^voos_(\d{4})\.csv$/i; // OPÇÃO A: exato voos_YYYY.csv

  // Campos finais que queremos manter (normalizados)
  const EXPECTED_COLUMNS = [
    'historico','solicitante','orgao_solicitante','situacao_voo','horas_voadas','aeronave','n_db','base','data','orgao_responsavel','origem','destino','passageiro','cargo_funcao','orgao_passageiro'
  ];

  // Estado
  let dadosCache = { voos: [], anos: [], origens: [], destinos: [], passageiros: [], files: [] };
  let dadosFiltrados = [];
  let uniqueFlightsIndex = {}; // para contar voos únicos
  let currentPage = 1;
  const pageSize = 50;

  // Paleta de cores (para Plotly)
  const COLORS = ['var(--palette-5)','var(--palette-2)','var(--palette-3)','var(--palette-4)','var(--palette-6)','var(--palette-7)','var(--palette-8)','#C55','#7FB3D5','#9ACD32'];

  // ----------------------------
  // Util: limpar BOM e normalizar cabecalhos
  // ----------------------------
  function limparBOM(s){ return s ? s.replace(/^\uFEFF/, '') : s; }
  function normalizeHeader(h){
    if(!h) return '';
    let s = limparBOM(String(h)).trim();
    // remover acentos
    s = s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    s = s.replace(/[^\w]+/g, '_').replace(/^_|_$/g,'').toLowerCase();
    return s;
  }

  // ----------------------------
  // UI util
  // ----------------------------
  function showLoading(text='Carregando...'){ document.getElementById('loadingText').textContent = text; document.getElementById('loadingOverlay').style.display='flex'; updateStatus('updating', text); }
  function hideLoading(){ document.getElementById('loadingOverlay').style.display='none'; }
  function updateStatus(status, text){ const el = document.getElementById('updateStatus'); el.className = `update-status ${status}`; document.getElementById('updateStatusText').textContent = text; }
  function mostrarNotificacao(msg,type='info'){ const d=document.createElement('div'); d.className = `alert alert-${type}`; d.style.position='fixed'; d.style.right='20px'; d.style.top='20px'; d.style.zIndex=10000; d.innerHTML = msg + ' <button class="btn-close" onclick="this.parentElement.remove()"></button>'; document.body.appendChild(d); setTimeout(()=>d.remove(),6000); }

  // ----------------------------
  // Buscar lista de arquivos via GitHub Contents API (public repo -> CORS ok)
  // ----------------------------
  async function listarArquivosNoRepo(){
    try{
      showLoading('Buscando lista de arquivos no GitHub...');
      updateStatus('updating','Verificando arquivos no repositório');
      const res = await fetch(GITHUB_API_CONTENTS);
      if(!res.ok) throw new Error('Erro listagem: ' + res.status);
      const items = await res.json();
      // Filtrar por nome exato voos_YYYY.csv (OPÇÃO A)
      const files = items
        .filter(it => it.type === 'file' && FILENAME_REGEX.test(it.name))
        .map(it => ({ name: it.name, download_url: it.download_url, year: (it.name.match(FILENAME_REGEX)||[])[1] }));
      // ordenar do mais novo para o mais antigo
      files.sort((a,b) => (b.year||'').localeCompare(a.year||''));
      dadosCache.files = files;
      return files;
    }catch(err){
      console.error('Erro listarArquivosNoRepo', err);
      mostrarNotificacao('Erro ao listar arquivos no GitHub: ' + err.message,'danger');
      return [];
    }finally{
      hideLoading();
    }
  }

  // ----------------------------
  // Parse CSV com PapaParse (com transformHeader)
  // ----------------------------
  function parseCSV(text){
    return new Promise((resolve,reject)=>{
      Papa.parse(text, {
        header: true,
        skipEmptyLines: true,
        transformHeader: h => normalizeHeader(h),
        complete: results => resolve(results.data),
        error: err => reject(err)
      });
    });
  }

  // ----------------------------
  // Processar e manter APENAS colunas desejadas
  // ----------------------------
  function processarLinhas(rawRows, inferredYear=''){
    // rawRows já têm cabeçalhos normalizados por parseCSV
    const mapped = rawRows.map(r => {
      const row = {};
      // mapear somente as colunas esperadas; se faltar, deixar vazia
      EXPECTED_COLUMNS.forEach(col => {
        const alt = col.replace(/_/g,'_'); // already normalized
        row[col] = (r[col] !== undefined && r[col] !== null) ? String(r[col]).trim() : '';
      });
      // Normalizar horas (virgula -> ponto)
      let hv = row['horas_voadas'] || '';
      hv = hv.toString().replace(',', '.').replace(/\s+/g,'');
      row.horas_voadas = (hv === '' ? 0 : parseFloat(hv)) || 0;
      // n_db (número do voo) — manter como string
      row.n_db = (row.n_db || '').toString().trim();
      // data raw
      row.data = row.data || '';
      // origin/destino/passageiro
      row.origem = (row.origem || '').toString().trim();
      row.destino = (row.destino || '').toString().trim();
      row.passageiro = (row.passageiro || '').toString().trim();
      // situacao_voo (usar como está)
      row.situacao_voo = (row.situacao_voo || '').toString().trim();
      // adiciona ano se possível
      const m = (row.data || '').match(/(\d{4})/);
      row.ano = m ? m[1] : inferredYear || '';
      return row;
    });
    // filtrar linhas com data/origem/destino (exigido)
    return mapped.filter(r => r.data && r.origem && r.destino);
  }

  // ----------------------------
  // Carregar TODOS os arquivos encontrados e agregar
  // ----------------------------
  async function carregarTodosArquivos(){
    showLoading('Carregando arquivos CSV...');
    updateStatus('updating','Carregando dados do repositório');
    try{
      const files = await listarArquivosNoRepo();
      if(!files || files.length === 0){
        updateStatus('offline','Nenhum arquivo voos_YYYY.csv encontrado');
        mostrarNotificacao('Nenhum arquivo voos_YYYY.csv encontrado em /docs/data/normalized','warning');
        return;
      }
      // popular lista de downloads UI
      renderArquivoLista(files);

      const allRows = [];
      for(const f of files){
        try{
          const raw = await fetch(f.download_url);
          if(!raw.ok){ console.warn('falha ao baixar', f.name, raw.status); continue; }
          const text = await raw.text();
          const parsed = await parseCSV(text);
          const processed = processarLinhas(parsed, f.year);
          // atribuir ano se faltou
          processed.forEach(p => { if(!p.ano) p.ano = f.year; });
          allRows.push(...processed);
        }catch(e){
          console.error('erro fetch/process', f.name, e);
        }
      }

      dadosCache.voos = allRows;
      // atualizar meta
      dadosCache.anos = Array.from(new Set(allRows.map(x=>x.ano).filter(Boolean))).sort().reverse();
      dadosCache.origens = Array.from(new Set(allRows.map(x=>x.origem).filter(Boolean))).sort();
      dadosCache.destinos = Array.from(new Set(allRows.map(x=>x.destino).filter(Boolean))).sort();
      dadosCache.passageiros = Array.from(new Set(allRows.map(x=>x.passageiro).filter(Boolean))).sort();
      updateStatus('online', `Dados carregados (${allRows.length} registros)`);
      // inicializar selects e view
      atualizarSelects();
      aplicarFiltros(); // aplica padrão
    }catch(err){
      console.error('Erro carregarTodosArquivos', err);
      updateStatus('offline','Erro ao carregar dados');
      mostrarNotificacao('Erro ao carregar dados: ' + err.message,'danger');
    }finally{
      hideLoading();
    }
  }

  // ----------------------------
  // Atualizar selects (anos, origens, destinos, passageiros)
  // ----------------------------
  function atualizarSelects(){
    // anos
    const selAno = document.getElementById('filter-ano');
    const analiseAno = document.getElementById('analise-ano');
    selAno.innerHTML = ''; analiseAno.innerHTML = '';
    const anos = dadosCache.anos.length ? dadosCache.anos : ['2025','2021'];
    anos.forEach(a => {
      const opt = document.createElement('option'); opt.value = a; opt.textContent = a; selAno.appendChild(opt);
      const opt2 = document.createElement('option'); opt2.value = a; opt2.textContent = a; analiseAno.appendChild(opt2);
    });
    // adicionar opção "Todos"
    const oAll = document.createElement('option'); oAll.value='all'; oAll.textContent='Todos os anos'; selAno.appendChild(oAll);
    const aAll = document.createElement('option'); aAll.value='all'; aAll.textContent='Todos'; analiseAno.appendChild(aAll);
    // selecionar padrão = maior ano
    if(dadosCache.anos.length) selAno.value = dadosCache.anos[0];
    analiseAno.value = selAno.value;

    // origens
    const selOrig = document.getElementById('filter-origem');
    selOrig.innerHTML = '<option value="all">Todas as origens</option>';
    dadosCache.origens.forEach(o => { const opt = document.createElement('option'); opt.value = o; opt.textContent = o; selOrig.appendChild(opt); });

    // destinos
    const selDest = document.getElementById('filter-destino');
    selDest.innerHTML = '<option value="all">Todos os destinos</option>';
    const analiseDest = document.getElementById('analise-destino'); analiseDest.innerHTML = '<option value="all">Todos os destinos</option>';
    dadosCache.destinos.forEach(d => { const opt = document.createElement('option'); opt.value = d; opt.textContent = d; selDest.appendChild(opt); analiseDest.appendChild(opt.cloneNode(true)); });

    // passageiros
    const selPass = document.getElementById('filter-passageiro'); selPass.innerHTML = '<option value="all">Todos</option>';
    const analisePass = document.getElementById('analise-passageiro'); analisePass.innerHTML = '<option value="all">Todos</option>';
    dadosCache.passageiros.forEach(p => { const opt = document.createElement('option'); opt.value = p; opt.textContent = p; selPass.appendChild(opt); analisePass.appendChild(opt.cloneNode(true)); });
  }

  // ----------------------------
  // Render arquivo lista (download links)
  // ----------------------------
  function renderArquivoLista(files){
    const container = document.getElementById('arquivos-lista');
    container.innerHTML = '';
    files.forEach(f => {
      const div = document.createElement('div'); div.className='list-group-item d-flex justify-content-between align-items-center';
      div.innerHTML = `<div><strong>${f.name}</strong><div class="small text-muted">Ano: ${f.year}</div></div>
        <div><a class="btn btn-sm btn-outline-primary" href="${f.download_url}" target="_blank"><i class="fas fa-download"></i> Baixar</a></div>`;
      container.appendChild(div);
    });
  }

  // ----------------------------
  // Aplicar filtros e atualizar view
  // ----------------------------
  function aplicarFiltros(){
    const ano = document.getElementById('filter-ano').value;
    const origem = document.getElementById('filter-origem').value;
    const destino = document.getElementById('filter-destino').value;
    const passageiro = document.getElementById('filter-passageiro').value;

    let dados = [...dadosCache.voos];
    if(ano && ano !== 'all') dados = dados.filter(d => d.ano === ano);
    if(origem && origem !== 'all') dados = dados.filter(d => d.origem === origem);
    if(destino && destino !== 'all') dados = dados.filter(d => d.destino === destino);
    if(passageiro && passageiro !== 'all') dados = dados.filter(d => d.passageiro === passageiro);

    // ordenar por data decrescente
    dados.sort((a,b)=> (b.data||'').localeCompare(a.data||''));

    dadosFiltrados = dados;
    currentPage = 1;
    atualizarEstatisticas(dados);
    atualizarGraficos(dados);
    atualizarTabela();
    atualizarPaginacao();
    document.getElementById('table-year').textContent = (ano === 'all' ? 'Todos' : (ano || '—'));
    document.getElementById('voos-count').textContent = `${dados.length} registros`;
  }

  function limparFiltros(){
    document.getElementById('filter-ano').value = (dadosCache.anos.length?dadosCache.anos[0]:'all');
    document.getElementById('filter-origem').value = 'all';
    document.getElementById('filter-destino').value = 'all';
    document.getElementById('filter-passageiro').value = 'all';
    aplicarFiltros();
  }

  // ----------------------------
  // Estatísticas, Gráficos e Tabela
  // ----------------------------
  function atualizarEstatisticas(dados){
    // calcular voos únicos: agrupar por key = data|n_db|origem|destino
    const flightKeys = new Set();
    dados.forEach(r => {
      const key = `${r.data}||${r.n_db}||${r.origem}||${r.destino}`;
      flightKeys.add(key);
    });
    const totalVoosUnicos = flightKeys.size;
    // horas totais somando horas_voadas por linha (se houver múltiplas linhas para o mesmo voo por vários passageiros, soma também)
    const totalHoras = dados.reduce((s,i)=> s + (parseFloat(i.horas_voadas)||0), 0);
    const passageirosUnicos = new Set(dados.map(d=>d.passageiro)).size;
    const destinosUnicos = new Set(dados.map(d=>d.destino)).size;

    document.getElementById('card-voos').textContent = totalVoosUnicos.toLocaleString('pt-BR');
    document.getElementById('card-horas').textContent = formatHoras(totalHoras);
    document.getElementById('card-passageiros').textContent = passageirosUnicos.toLocaleString('pt-BR');
    document.getElementById('card-destinos').textContent = destinosUnicos.toLocaleString('pt-BR');
  }

  function atualizarGraficos(dados){
    // PIE: top 10 destinos (contar voos únicos por destino)
    const destinoFlightMap = {}; // destino -> set de flightKeys
    dados.forEach(r=>{
      const flightKey = `${r.data}||${r.n_db}||${r.origem}||${r.destino}`;
      if(!destinoFlightMap[r.destino]) destinoFlightMap[r.destino] = new Set();
      destinoFlightMap[r.destino].add(flightKey);
    });
    const destinoCounts = Object.entries(destinoFlightMap).map(([dest, set])=> ({dest, count:set.size}));
    destinoCounts.sort((a,b)=>b.count - a.count);
    const top10 = destinoCounts.slice(0,10);
    const pieLabels = top10.map(d=>d.dest);
    const pieValues = top10.map(d=>d.count);
    const pieColors = COLORS.slice(0, pieLabels.length);
    Plotly.newPlot('chart-destino-pie', [{
      labels: pieLabels,
      values: pieValues,
      type: 'pie',
      marker:{colors: pieColors},
      textinfo: 'label+percent',
      hovertemplate: '%{label}: %{value} voos (%{percent})<extra></extra>'
    }], {paper_bgcolor:'transparent',plot_bgcolor:'transparent',margin:{t:10,b:30}}, {displayModeBar:false});

    // BAR: por mês (contar voos únicos por mês)
    const monthMap = {}; // yyyy-mm -> set flightKeys
    dados.forEach(r=>{
      // extrair yyyy-mm
      const m = (r.data || '').match(/(\d{4})-(\d{2})/);
      const ym = m ? `${m[1]}-${m[2]}` : r.data;
      const key = `${r.data}||${r.n_db}||${r.origem}||${r.destino}`;
      if(!monthMap[ym]) monthMap[ym] = new Set();
      monthMap[ym].add(key);
    });
    // ordenar meses por chave
    const months = Object.keys(monthMap).sort();
    const monthCounts = months.map(m => monthMap[m].size);
    const barColors = months.map((_,i)=> COLORS[i % COLORS.length]);
    Plotly.newPlot('chart-mes-bar', [{
      x: months,
      y: monthCounts,
      type: 'bar',
      marker:{color: barColors},
      hovertemplate: '%{x}: %{y} voos<extra></extra>'
    }], {paper_bgcolor:'transparent',plot_bgcolor:'transparent',margin:{t:10,b:80}}, {displayModeBar:false});
  }

  function atualizarTabela(){
    const start = (currentPage - 1) * pageSize;
    const page = dadosFiltrados.slice(start, start + pageSize);
    const tbody = document.getElementById('voos-table-body');
    if(!page || page.length === 0){
      tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum voo encontrado com os filtros aplicados</td></tr>';
      return;
    }
    let html = '';
    // precisamos contar quantos passageiros tem por voo único (group by flightKey)
    const flightsMap = {}; // flightKey -> {data, n_db, origem, destino, passageiros:set, situacao_voo, horas_voadas (take max/sum?)}
    page.forEach(row=>{
      const key = `${row.data}||${row.n_db}||${row.origem}||${row.destino}`;
      if(!flightsMap[key]) flightsMap[key] = {data: row.data, n_db: row.n_db, origem: row.origem, destino: row.destino, passageiros: new Set(), situacao_voo: row.situacao_voo, horas_voadas: 0};
      if(row.passageiro) flightsMap[key].passageiros.add(row.passageiro);
      // sumarizar horas_voadas (use sum)
      flightsMap[key].horas_voadas += (parseFloat(row.horas_voadas) || 0);
      // preferir situacao_voo se informado
      if(row.situacao_voo) flightsMap[key].situacao_voo = row.situacao_voo;
    });
    // iterate flightsMap
    Object.values(flightsMap).forEach(f=>{
      html += `<tr>
        <td>${escapeHtml(formatDate(f.data))}</td>
        <td>${escapeHtml(f.n_db)}</td>
        <td>${escapeHtml(f.origem)}</td>
        <td>${escapeHtml(f.destino)}</td>
        <td>${f.passageiros.size}</td>
        <td>${escapeHtml(f.situacao_voo || 'NÃO INFORMADO')}</td>
        <td>${formatHoras(f.horas_voadas)}</td>
      </tr>`;
    });
    tbody.innerHTML = html;
  }

  function atualizarPaginacao(){
    const totalItems = dadosFiltrados.length;
    const totalPages = Math.max(1, Math.ceil(totalItems / pageSize));
    const startItem = totalItems === 0 ? 0 : (currentPage-1)*pageSize + 1;
    const endItem = Math.min(currentPage*pageSize, totalItems);
    document.getElementById('pagination-info').textContent = `Mostrando ${startItem}-${endItem} de ${totalItems} registros (linhas)`;
    document.getElementById('btn-prev').disabled = currentPage <= 1;
    document.getElementById('btn-next').disabled = currentPage >= totalPages;
  }

  function mudarPagina(dir){
    const totalItems = dadosFiltrados.length;
    const totalPages = Math.max(1, Math.ceil(totalItems / pageSize));
    const np = currentPage + dir;
    if(np >= 1 && np <= totalPages){ currentPage = np; atualizarTabela(); atualizarPaginacao(); }
  }

  // ----------------------------
  // Análise por destino (agrupa por destino, mas calcula voos únicos)
  // ----------------------------
  function gerarAnalise(){
    const ano = document.getElementById('analise-ano').value;
    const destinoFilter = document.getElementById('analise-destino').value;
    const passageiroFilter = document.getElementById('analise-passageiro').value;

    let rows = [...dadosCache.voos];
    if(ano && ano !== 'all') rows = rows.filter(r => r.ano === ano);
    if(destinoFilter && destinoFilter !== 'all') rows = rows.filter(r => r.destino === destinoFilter);
    if(passageiroFilter && passageiroFilter !== 'all') rows = rows.filter(r => r.passageiro === passageiroFilter);

    // map dest -> set of flightKeys and passengers and horas
    const map = {};
    rows.forEach(r=>{
      const key = `${r.data}||${r.n_db}||${r.origem}||${r.destino}`;
      if(!map[r.destino]) map[r.destino] = {destino: r.destino, flightKeys: new Set(), horas: 0, passageiros: new Set()};
      map[r.destino].flightKeys.add(key);
      map[r.destino].horas += (parseFloat(r.horas_voadas) || 0);
      if(r.passageiro) map[r.destino].passageiros.add(r.passageiro);
    });

    const arr = Object.values(map).map(x => ({ destino: x.destino, totalVoos: x.flightKeys.size, horas: x.horas, passageiros: x.passageiros.size }));
    arr.sort((a,b)=> b.totalVoos - a.totalVoos);

    // calcular percentual de voos (relativo ao total de voos únicos no conjunto filtrado)
    const totalVoosGeral = arr.reduce((s,i)=>s+i.totalVoos,0) || 0;
    // preencher tabela
    const tbody = document.getElementById('analise-table-body');
    if(arr.length === 0){ tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum dado</td></tr>'; return; }
    let html = '';
    arr.forEach(a => {
      const pct = totalVoosGeral>0 ? ((a.totalVoos / totalVoosGeral) * 100).toFixed(1) + '%' : '0.0%';
      html += `<tr>
        <td>${escapeHtml(a.destino)}</td>
        <td>${a.totalVoos}</td>
        <td>${formatHoras(a.horas)}</td>
        <td>${a.passageiros}</td>
        <td>${pct}</td>
      </tr>`;
    });
    tbody.innerHTML = html;
    // estatísticas superiores
    document.getElementById('analise-total').textContent = totalVoosGeral.toLocaleString('pt-BR');
    const totalHoras = arr.reduce((s,i)=>s + (i.horas||0),0);
    document.getElementById('analise-horas').textContent = formatHoras(totalHoras);
    const totalPass = new Set(rows.map(r=>r.passageiro)).size;
    document.getElementById('analise-passageiros').textContent = totalPass.toLocaleString('pt-BR');
    document.getElementById('analise-sucesso').textContent = '—';
  }

  // ----------------------------
  // Export CSV (dadosFiltrados)
  // ----------------------------
  function exportarParaCSV(){
    if(!dadosFiltrados || dadosFiltrados.length === 0){ mostrarNotificacao('Nenhum dado para exportar','warning'); return; }
    // exportar linhas filtradas (raw rows)
    const headers = EXPECTED_COLUMNS;
    const rows = [headers.join(',')];
    dadosFiltrados.forEach(r=>{
      const line = headers.map(h=>{
        const v = r[h] === undefined || r[h] === null ? '' : String(r[h]);
        return (v.includes(',')||v.includes('"')) ? `"${v.replace(/"/g,'""')}"` : v;
      }).join(',');
      rows.push(line);
    });
    const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `voos_filtrados_${new Date().toISOString().slice(0,10)}.csv`; a.style.display='none'; document.body.appendChild(a); a.click(); a.remove();
    mostrarNotificacao(`Exportado ${dadosFiltrados.length} linhas para CSV`,'success');
  }

  // ----------------------------
  // Helpers de formatação
  // ----------------------------
  function formatDate(d){
    if(!d) return '';
    // tenta ISO
    const dt = new Date(d);
    if(!isNaN(dt.getTime())) return dt.toLocaleDateString('pt-BR');
    const m = d.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if(m) return `${m[3]}/${m[2]}/${m[1]}`;
    return d;
  }
  function formatHoras(h){
    if(h === null || h === undefined || isNaN(h)) return '—';
    const hi = Math.floor(h);
    const min = Math.round((h - hi) * 60);
    return `${hi}h${min>0 ? ' '+min+'m' : ''}`;
  }
  function escapeHtml(s){ if(s === null || s === undefined) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // ----------------------------
  // Event listeners e inicializacao
  // ----------------------------
  document.addEventListener('DOMContentLoaded', () => {
    // Tabs
    document.querySelectorAll('.nav-link').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab-pane').forEach(tp=>tp.style.display='none');
        const target = btn.getAttribute('data-target');
        document.querySelector(target).style.display = 'block';
      });
    });

    // Botões
    document.getElementById('btn-apply').addEventListener('click', aplicarFiltros);
    document.getElementById('btn-clear').addEventListener('click', limparFiltros);
    document.getElementById('btn-prev').addEventListener('click', ()=>mudarPagina(-1));
    document.getElementById('btn-next').addEventListener('click', ()=>mudarPagina(1));
    document.getElementById('exportCSV').addEventListener('click', exportarParaCSV);
    document.getElementById('btn-analisar').addEventListener('click', gerarAnalise);

    // iniciar carregamento de arquivos
    carregarTodosArquivos();
  });

  // ----------------------------
  // Fim
  // ----------------------------
  </script>
</body>
</html>
