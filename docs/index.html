<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Voos Oficiais — Governo de Minas Gerais</title>
  
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <!-- Tippy.js para tooltips -->
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <!-- PapaParse para CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  
  <style>
    :root {
      --primary-dark: #29435A;
      --primary-darker: #132837;
      --accent-red: #B93C42;
      --accent-bright: #DB233F;
      --background-light: #EEEFF5;
      --success-green: #28a745;
      --warning-yellow: #ffc107;
      --info-blue: #17a2b8;
      --secondary-blue: #2E5984;
      --secondary-green: #2E8B57;
      --secondary-purple: #6A5ACD;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--background-light);
      padding-bottom: 30px;
    }
    
    .main-header {
      background: linear-gradient(135deg, var(--primary-darker) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 25px 0;
      margin-bottom: 30px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      border-bottom: 4px solid var(--accent-red);
    }
    
    .logo-container {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .logo {
      width: 70px;
      height: 70px;
      background: linear-gradient(135deg, var(--accent-red) 0%, var(--accent-bright) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(219, 35, 63, 0.3);
    }
    
    .header-title {
      font-weight: 800;
      font-size: 28px;
      margin: 0;
      letter-spacing: -0.5px;
    }
    
    .header-subtitle {
      font-size: 16px;
      opacity: 0.9;
      margin: 5px 0 0 0;
    }
    
    .filter-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      padding: 25px;
      margin-bottom: 30px;
      border-left: 5px solid var(--accent-red);
      border-top: 1px solid #e9ecef;
    }
    
    .filter-label {
      font-weight: 700;
      color: var(--primary-dark);
      margin-bottom: 8px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .form-control, .form-select {
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 12px 15px;
      font-size: 14px;
      transition: all 0.3s ease;
      height: 48px;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--accent-red);
      box-shadow: 0 0 0 3px rgba(185, 60, 66, 0.15);
    }
    
    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      margin-bottom: 25px;
      height: 100%;
      min-height: 320px;
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--background-light);
    }
    
    .chart-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary-dark);
      margin: 0;
    }
    
    .chart-wrapper {
      position: relative;
      height: 250px;
      width: 100%;
    }
    
    .table-container {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      margin-bottom: 25px;
    }
    
    .table-header {
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-darker) 100%);
      color: white;
      padding: 20px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .table-title {
      font-size: 18px;
      font-weight: 700;
      margin: 0;
    }
    
    .table-badge {
      background: var(--accent-red);
      color: white;
      padding: 6px 15px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }
    
    .table {
      margin: 0;
      width: 100%;
    }
    
    .table thead th {
      background-color: #f8f9fa;
      color: var(--primary-dark);
      font-weight: 700;
      border: none;
      padding: 18px 15px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease;
    }
    
    .table thead th:hover {
      background-color: rgba(41, 67, 90, 0.05);
    }
    
    .table tbody tr {
      transition: background-color 0.2s ease;
      border-bottom: 1px solid #f1f1f1;
    }
    
    .table tbody tr:hover {
      background-color: rgba(41, 67, 90, 0.04);
    }
    
    .table tbody td {
      padding: 16px 15px;
      vertical-align: middle;
      font-size: 14px;
    }
    
    .btn-primary-custom {
      background: linear-gradient(to right, var(--accent-red), var(--accent-bright));
      border: none;
      padding: 12px 30px;
      font-weight: 700;
      border-radius: 8px;
      transition: all 0.3s ease;
      font-size: 15px;
      color: white;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary-custom:hover {
      background: linear-gradient(to right, var(--accent-bright), var(--accent-red));
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(219, 35, 63, 0.25);
      color: white;
    }
    
    .btn-secondary-custom {
      background: white;
      border: 2px solid var(--primary-dark);
      color: var(--primary-dark);
      padding: 12px 30px;
      font-weight: 700;
      border-radius: 8px;
      transition: all 0.3s ease;
      font-size: 15px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-secondary-custom:hover {
      background-color: var(--primary-dark);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(41, 67, 90, 0.2);
    }
    
    .nav-tabs-container {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 25px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    .nav-tabs {
      border: none;
      gap: 5px;
    }
    
    .nav-tabs .nav-link {
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      font-weight: 600;
      color: var(--primary-dark);
      transition: all 0.3s ease;
      font-size: 15px;
    }
    
    .nav-tabs .nav-link:hover {
      background-color: rgba(41, 67, 90, 0.05);
      color: var(--accent-red);
    }
    
    .nav-tabs .nav-link.active {
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-darker) 100%);
      color: white;
    }
    
    .actions-container {
      background: white;
      border-radius: 12px;
      padding: 20px 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .export-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn-export {
      background: white;
      border: 2px solid var(--primary-dark);
      color: var(--primary-dark);
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }
    
    .btn-export:hover {
      background: var(--primary-dark);
      color: white;
      transform: translateY(-2px);
    }
    
    .social-share {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .social-share-label {
      font-weight: 600;
      color: var(--primary-dark);
      font-size: 14px;
    }
    
    .btn-social {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      transition: all 0.3s ease;
      text-decoration: none;
    }
    
    .btn-social:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      color: white;
    }
    
    .card-stats {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      margin-bottom: 25px;
      text-align: center;
    }
    
    .card-stats .value {
      font-size: 32px;
      font-weight: 800;
      color: var(--accent-red);
      margin: 10px 0;
    }
    
    .card-stats .label {
      font-size: 14px;
      color: var(--primary-dark);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .card-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
    }
    
    .dashboard-full {
      grid-column: 1 / -1;
    }
    
    .link-clicavel {
      color: var(--primary-dark);
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-block;
      padding: 2px 4px;
      border-radius: 4px;
    }
    
    .link-clicavel:hover {
      color: var(--accent-red);
      background-color: rgba(185, 60, 66, 0.05);
      transform: translateY(-1px);
    }
    
    .badge-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    .badge-realizado {
      background-color: rgba(52, 168, 83, 0.1);
      color: var(--secondary-green);
    }
    
    .badge-cancelado {
      background-color: rgba(234, 67, 53, 0.1);
      color: var(--accent-red);
    }
    
    .current-year-indicator {
      background: linear-gradient(135deg, var(--secondary-green) 0%, #2e8b47 100%);
      color: white;
      padding: 6px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .footer {
      text-align: center;
      padding: 20px;
      color: var(--primary-dark);
      font-size: 0.9rem;
      border-top: 1px solid var(--border);
      margin-top: 40px;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      display: none;
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(41, 67, 90, 0.1);
      border-radius: 50%;
      border-top-color: var(--accent-red);
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
    
    /* Status de atualização */
    .update-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: var(--primary-dark);
      padding: 6px 12px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.9);
    }
    
    .update-status.online {
      color: var(--secondary-green);
      background: rgba(52, 168, 83, 0.1);
    }
    
    .update-status.offline {
      color: var(--accent-red);
      background: rgba(234, 67, 53, 0.1);
    }
    
    .update-status.updating {
      color: var(--warning-yellow);
      background: rgba(255, 193, 7, 0.1);
    }
    
    .data-source-info {
      font-size: 0.8rem;
      color: var(--primary-dark);
      opacity: 0.8;
      margin-top: 5px;
    }
    
    @media (max-width: 992px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .card-stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .header-title {
        font-size: 22px;
      }
      
      .actions-container {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .export-buttons {
        width: 100%;
        justify-content: flex-start;
      }
      
      .social-share {
        width: 100%;
        justify-content: flex-start;
        margin-top: 15px;
      }
      
      .nav-tabs .nav-link {
        padding: 10px 15px;
        font-size: 14px;
      }
      
      .card-stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="ms-3">
      <p class="mb-1" id="loadingText">Carregando dados...</p>
      <div class="progress" style="width: 200px; height: 8px;">
        <div id="loadingProgress" class="progress-bar" style="width: 0%; background-color: var(--accent-red);"></div>
      </div>
    </div>
  </div>

  <!-- Header Principal -->
  <header class="main-header">
    <div class="container">
      <div class="logo-container">
        <div class="logo">
          <i class="fas fa-plane"></i>
        </div>
        <div>
          <h1 class="header-title">Painel de Voos Oficiais</h1>
          <p class="header-subtitle">Governo do Estado de Minas Gerais - Transparência de Voos Oficiais</p>
          <div class="d-flex align-items-center gap-3 mt-2">
            <a href="https://dados.mg.gov.br" target="_blank" class="link-legislacao" style="color: white; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; opacity: 0.9; transition: opacity 0.3s;">
              <i class="fas fa-external-link-alt"></i> Portal de Dados Abertos
            </a>
            <a href="https://github.com/transparencia-mg/voos_oficiais_governador/tree/main/docs/data/normalized" target="_blank" class="link-legislacao" style="color: white; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; opacity: 0.9; transition: opacity 0.3s;">
              <i class="fab fa-github"></i> Repositório GitHub
            </a>
          </div>
        </div>
      </div>
      <div class="mt-3 d-flex justify-content-end">
        <div class="update-status online" id="updateStatus">
          <i class="fas fa-circle"></i>
          <span id="updateStatusText">Dados atualizados</span>
          <small id="lastUpdateTime">Agora</small>
        </div>
      </div>
    </div>
  </header>

  <!-- Conteúdo Principal -->
  <div class="container">
    <!-- Menu de Navegação -->
    <div class="nav-tabs-container">
      <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
            <i class="fas fa-chart-pie me-2"></i>Visão Geral
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="destinos-tab" data-bs-toggle="tab" data-bs-target="#destinos" type="button" role="tab">
            <i class="fas fa-map-marker-alt me-2"></i>Destinos
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="download-tab" data-bs-toggle="tab" data-bs-target="#download" type="button" role="tab">
            <i class="fas fa-download me-2"></i>Download de Dados
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="relatorios-tab" data-bs-toggle="tab" data-bs-target="#relatorios" type="button" role="tab">
            <i class="fas fa-file-alt me-2"></i>Relatórios
          </button>
        </li>
      </ul>
    </div>

    <!-- Conteúdo das Abas -->
    <div class="tab-content" id="dashboardTabsContent">
      <!-- ABA 1: VISÃO GERAL -->
      <div class="tab-pane fade show active" id="overview" role="tabpanel">
        <!-- Filtros -->
        <div class="filter-container">
          <div class="row">
            <div class="col-md-3">
              <div class="mb-3">
                <label for="filter-ano" class="form-label filter-label">Ano</label>
                <select class="form-select" id="filter-ano">
                  <option value="all">Todos os anos</option>
                  <!-- Os anos serão carregados dinamicamente -->
                </select>
              </div>
            </div>
            <div class="col-md-3">
              <div class="mb-3">
                <label for="filter-origem" class="form-label filter-label">Origem</label>
                <select class="form-select" id="filter-origem">
                  <option value="all">Todas as origens</option>
                  <!-- As origens serão carregadas dinamicamente -->
                </select>
              </div>
            </div>
            <div class="col-md-3">
              <div class="mb-3">
                <label for="filter-destino" class="form-label filter-label">Destino</label>
                <select class="form-select" id="filter-destino">
                  <option value="all">Todos os destinos</option>
                  <!-- Os destinos serão carregados dinamicamente -->
                </select>
              </div>
            </div>
            <div class="col-md-3">
              <div class="mb-3">
                <label for="filter-situacao" class="form-label filter-label">Situação</label>
                <select class="form-select" id="filter-situacao">
                  <option value="all">Todas as situações</option>
                  <option value="REALIZADO">REALIZADO</option>
                  <option value="CANCELADO">CANCELADO</option>
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-12">
              <div class="d-flex gap-3">
                <button class="btn-primary-custom" id="btn-apply">
                  <i class="fas fa-filter me-2"></i>Aplicar Filtros
                </button>
                <button class="btn-secondary-custom" id="btn-clear">
                  <i class="fas fa-redo me-2"></i>Limpar Filtros
                </button>
                <button class="btn-secondary-custom" id="btn-refresh-data">
                  <i class="fas fa-sync-alt me-2"></i>Atualizar Dados
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Ações -->
        <div class="actions-container">
          <div class="export-buttons">
            <button class="btn-export" id="exportCSV">
              <i class="fas fa-file-csv"></i> CSV
            </button>
            <button class="btn-export" id="exportExcel">
              <i class="fas fa-file-excel"></i> Excel
            </button>
            <button class="btn-export" id="exportPDF">
              <i class="fas fa-file-pdf"></i> PDF
            </button>
            <button class="btn-export" id="btn-print">
              <i class="fas fa-print"></i> Imprimir
            </button>
          </div>
          
          <div class="social-share">
            <span class="social-share-label">Compartilhar:</span>
            <a href="#" class="btn-social btn-facebook" style="background: #3b5998;">
              <i class="fab fa-facebook-f"></i>
            </a>
            <a href="#" class="btn-social btn-twitter" style="background: #1da1f2;">
              <i class="fab fa-twitter"></i>
            </a>
            <a href="#" class="btn-social btn-linkedin" style="background: #0077b5;">
              <i class="fab fa-linkedin-in"></i>
            </a>
            <a href="#" class="btn-social btn-whatsapp" style="background: #25d366;">
              <i class="fab fa-whatsapp"></i>
            </a>
          </div>
        </div>

        <!-- Cards de Estatísticas -->
        <div class="card-stats-grid">
          <div class="card-stats">
            <i class="fas fa-plane fa-2x" style="color: var(--accent-red);"></i>
            <div class="value" id="card-voos">—</div>
            <div class="label">Voos</div>
            <div class="data-source-info" id="card-voos-source">Carregando...</div>
          </div>
          <div class="card-stats">
            <i class="fas fa-clock fa-2x" style="color: var(--secondary-blue);"></i>
            <div class="value" id="card-horas">—</div>
            <div class="label">Horas Voadas</div>
            <div class="data-source-info" id="card-horas-source">Carregando...</div>
          </div>
          <div class="card-stats">
            <i class="fas fa-users fa-2x" style="color: var(--secondary-green);"></i>
            <div class="value" id="card-pass">—</div>
            <div class="label">Passageiros</div>
            <div class="data-source-info" id="card-pass-source">Carregando...</div>
          </div>
          <div class="card-stats">
            <i class="fas fa-map-marker-alt fa-2x" style="color: var(--secondary-purple);"></i>
            <div class="value" id="card-destinos">—</div>
            <div class="label">Destinos</div>
            <div class="data-source-info" id="card-destinos-source">Carregando...</div>
          </div>
        </div>

        <!-- Gráficos -->
        <div class="dashboard-grid">
          <div class="chart-container">
            <div class="chart-header">
              <h4 class="chart-title">Top Destinos com Mais Voos</h4>
              <div class="data-source-info">Fonte: GitHub</div>
            </div>
            <div class="chart-wrapper">
              <div id="chart-destinos" style="height:100%; width:100%;"></div>
            </div>
          </div>
          <div class="chart-container">
            <div class="chart-header">
              <h4 class="chart-title">Voos por Mês</h4>
              <div class="data-source-info">Fonte: GitHub</div>
            </div>
            <div class="chart-wrapper">
              <div id="chart-meses" style="height:100%; width:100%;"></div>
            </div>
          </div>
        </div>

        <!-- Tabela -->
        <div class="table-container">
          <div class="table-header">
            <h3 class="table-title">Detalhamento de Voos</h3>
            <div class="d-flex align-items-center gap-3">
              <span class="current-year-indicator">
                <i class="fas fa-calendar-alt"></i> Dados: <span id="table-year">Carregando...</span>
              </span>
              <span class="table-badge" id="voos-count">0 voos</span>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th onclick="sortTable('voos', 'data')">
                    Data <span class="sort-icon">▼</span>
                  </th>
                  <th onclick="sortTable('voos', 'origem')">
                    Origem <span class="sort-icon">▼</span>
                  </th>
                  <th onclick="sortTable('voos', 'destino')">
                    Destino <span class="sort-icon">▼</span>
                  </th>
                  <th onclick="sortTable('voos', 'passageiro')">
                    Passageiro <span class="sort-icon">▼</span>
                  </th>
                  <th onclick="sortTable('voos', 'horas_voo')">
                    Horas <span class="sort-icon">▼</span>
                  </th>
                  <th onclick="sortTable('voos', 'situacao')">
                    Status <span class="sort-icon">▼</span>
                  </th>
                </tr>
              </thead>
              <tbody id="voos-table-body">
                <tr><td colspan="6" class="text-center">Carregando dados do GitHub...</td></tr>
              </tbody>
              <tfoot id="voos-table-footer">
                <!-- Rodapé carregado via JavaScript -->
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <!-- ABA 2: DESTINOS -->
      <div class="tab-pane fade" id="destinos" role="tabpanel">
        <!-- Filtros -->
        <div class="filter-container">
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label for="destinos-ano" class="form-label filter-label">Ano</label>
                <select class="form-select" id="destinos-ano">
                  <option value="all">Todos os anos</option>
                  <!-- Os anos serão carregados dinamicamente -->
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="destinos-destino" class="form-label filter-label">Destino</label>
                <select class="form-select" id="destinos-destino">
                  <option value="all">Todos os destinos</option>
                  <!-- Os destinos serão carregados dinamicamente -->
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="destinos-situacao" class="form-label filter-label">Situação</label>
                <select class="form-select" id="destinos-situacao">
                  <option value="all">Todas as situações</option>
                  <option value="REALIZADO">REALIZADO</option>
                  <option value="CANCELADO">CANCELADO</option>
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-12">
              <div class="d-flex gap-3">
                <button class="btn-primary-custom" id="btn-apply-destinos">
                  <i class="fas fa-filter me-2"></i>Aplicar Filtros
                </button>
                <button class="btn-secondary-custom" id="btn-clear-destinos">
                  <i class="fas fa-redo me-2"></i>Limpar Filtros
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Ações -->
        <div class="actions-container">
          <div class="export-buttons">
            <button class="btn-export" id="exportCSV-destinos">
              <i class="fas fa-file-csv"></i> CSV
            </button>
            <button class="btn-export" id="exportExcel-destinos">
              <i class="fas fa-file-excel"></i> Excel
            </button>
            <button class="btn-export" id="exportPDF-destinos">
              <i class="fas fa-file-pdf"></i> PDF
            </button>
            <button class="btn-export" id="btn-print-destinos">
              <i class="fas fa-print"></i> Imprimir
            </button>
          </div>
          
          <div class="social-share">
            <span class="social-share-label">Compartilhar:</span>
            <a href="#" class="btn-social btn-facebook" style="background: #3b5998;">
              <i class="fab fa-facebook-f"></i>
            </a>
            <a href="#" class="btn-social btn-twitter" style="background: #1da1f2;">
              <i class="fab fa-twitter"></i>
            </a>
            <a href="#" class="btn-social btn-linkedin" style="background: #0077b5;">
              <i class="fab fa-linkedin-in"></i>
            </a>
            <a href="#" class="btn-social btn-whatsapp" style="background: #25d366;">
              <i class="fab fa-whatsapp"></i>
            </a>
          </div>
        </div>

        <!-- Gráficos -->
        <div class="dashboard-grid">
          <div class="chart-container">
            <div class="chart-header">
              <h4 class="chart-title">Distribuição por Situação</h4>
              <div class="data-source-info">Fonte: GitHub</div>
            </div>
            <div class="chart-wrapper">
              <div id="chart-situacao-destinos" style="height:100%; width:100%;"></div>
            </div>
          </div>
          <div class="chart-container">
            <div class="chart-header">
              <h4 class="chart-title">Top 10 Destinos Mais Frequentes</h4>
              <div class="data-source-info">Fonte: GitHub</div>
            </div>
            <div class="chart-wrapper">
              <div id="chart-top-destinos" style="height:100%; width:100%;"></div>
            </div>
          </div>
        </div>

        <!-- Tabela -->
        <div class="table-container">
          <div class="table-header">
            <h3 class="table-title">Análise de Destinos</h3>
            <div class="d-flex align-items-center gap-3">
              <span class="current-year-indicator">
                <i class="fas fa-calendar-alt"></i> Período: <span id="destinos-period">Carregando...</span>
              </span>
              <span class="table-badge" id="destinos-count">0 destinos</span>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th onclick="sortTable('destinos', 'destino')">
                    Destino <span class="sort-icon">▼</span>
                  </th>
                  <th onclick="sortTable('destinos', 'quantidade')">
                    Quantidade <span class="sort-icon">▼</span>
                  </th>
                  <th onclick="sortTable('destinos', 'horas_totais')">
                    Horas Totais <span class="sort-icon">▼</span>
                  </th>
                  <th onclick="sortTable('destinos', 'realizados')">
                    Realizados <span class="sort-icon">▼</span>
                  </th>
                  <th onclick="sortTable('destinos', 'cancelados')">
                    Cancelados <span class="sort-icon">▼</span>
                  </th>
                  <th onclick="sortTable('destinos', 'taxa_sucesso')">
                    Taxa Sucesso <span class="sort-icon">▼</span>
                  </th>
                </tr>
              </thead>
              <tbody id="destinos-table-body">
                <tr><td colspan="6" class="text-center">Carregando dados do GitHub...</td></tr>
              </tbody>
              <tfoot id="destinos-table-footer">
                <!-- Rodapé carregado via JavaScript -->
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <!-- ABA 3: DOWNLOAD DE DADOS -->
      <div class="tab-pane fade" id="download" role="tabpanel">
        <!-- Filtros para Download -->
        <div class="filter-container">
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label for="download-year" class="form-label filter-label">Ano</label>
                <select class="form-select" id="download-year">
                  <option value="all">Todos os anos (consolidado)</option>
                  <!-- Os anos serão carregados dinamicamente -->
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="download-format" class="form-label filter-label">Formato</label>
                <select class="form-select" id="download-format">
                  <option value="csv">CSV (Original do GitHub)</option>
                  <option value="json">JSON</option>
                  <option value="xlsx">Excel</option>
                  <option value="pdf">PDF</option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="download-filter" class="form-label filter-label">Com Filtros Ativos?</label>
                <select class="form-select" id="download-filter">
                  <option value="no">Sem filtros - dados completos</option>
                  <option value="yes">Com filtros aplicados</option>
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-12">
              <div class="d-flex gap-3">
                <button class="btn-primary-custom" id="btn-download-year">
                  <i class="fas fa-download me-2"></i>Baixar Dados
                </button>
                <a href="https://github.com/transparencia-mg/voos_oficiais_governador/tree/main/docs/data/normalized" target="_blank" class="btn-secondary-custom">
                  <i class="fab fa-github me-2"></i>Acessar GitHub
                </a>
                <button class="btn-secondary-custom" id="btn-check-updates">
                  <i class="fas fa-sync-alt me-2"></i>Verificar Atualizações
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Informações sobre os dados -->
        <div class="table-container">
          <div class="table-header">
            <h3 class="table-title">Dados de Voos Oficiais</h3>
            <div class="d-flex align-items-center gap-3">
              <span class="table-badge">Dados Abertos</span>
              <div class="update-status online" id="githubStatus">
                <i class="fab fa-github"></i>
                <span id="githubStatusText">GitHub Conectado</span>
              </div>
            </div>
          </div>
          <div class="p-4">
            <div class="row">
              <div class="col-md-6">
                <div class="card-stats">
                  <i class="fas fa-file-csv fa-3x mb-3" style="color: var(--secondary-green);"></i>
                  <h4>Dados Direto do GitHub</h4>
                  <p class="text-muted">Baixe os dados brutos diretamente do repositório GitHub em formato CSV.</p>
                  <div class="mt-3">
                    <button class="btn-export w-100" onclick="downloadFromGitHub('raw')">
                      <i class="fas fa-database me-2"></i>Baixar CSV Original
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card-stats">
                  <i class="fas fa-code fa-3x mb-3" style="color: var(--primary-dark);"></i>
                  <h4>API de Dados</h4>
                  <p class="text-muted">Acesse os dados via API para integração com outros sistemas.</p>
                  <div class="mt-3">
                    <a href="https://api.github.com/repos/transparencia-mg/voos_oficiais_governador/contents/docs/data/normalized" target="_blank" class="btn-export w-100 d-block text-decoration-none">
                      <i class="fas fa-code me-2"></i>Acessar API GitHub
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-4">
              <h5 class="mb-3">Arquivos Disponíveis no GitHub</h5>
              <div id="github-files" class="list-group">
                <div class="list-group-item">
                  <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">Carregando arquivos...</h6>
                    <small class="text-muted">—</small>
                  </div>
                  <p class="mb-1">Aguardando conexão com GitHub...</p>
                  <small>—</small>
                </div>
              </div>
            </div>

            <div class="mt-4">
              <h5 class="mb-3">Metadados da Estrutura</h5>
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Campo</th>
                    <th>Descrição</th>
                    <th>Tipo</th>
                    <th>Exemplo</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>data</td>
                    <td>Data do voo</td>
                    <td>Data</td>
                    <td>2024-03-15</td>
                  </tr>
                  <tr>
                    <td>origem</td>
                    <td>Aeroporto de origem</td>
                    <td>Texto</td>
                    <td>CNF (Belo Horizonte)</td>
                  </tr>
                  <tr>
                    <td>destino</td>
                    <td>Aeroporto de destino</td>
                    <td>Texto</td>
                    <td>GRU (São Paulo)</td>
                  </tr>
                  <tr>
                    <td>passageiro</td>
                    <td>Nome do passageiro</td>
                    <td>Texto</td>
                    <td>João Silva</td>
                  </tr>
                  <tr>
                    <td>horas_voo</td>
                    <td>Duração do voo em horas</td>
                    <td>Decimal</td>
                    <td>1.5</td>
                  </tr>
                  <tr>
                    <td>situacao</td>
                    <td>Situação do voo</td>
                    <td>Texto</td>
                    <td>REALIZADO</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ABA 4: RELATÓRIOS -->
      <div class="tab-pane fade" id="relatorios" role="tabpanel">
        <!-- Filtros para Relatórios -->
        <div class="filter-container">
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label for="relatorio-ano" class="form-label filter-label">Ano do Relatório</label>
                <select class="form-select" id="relatorio-ano">
                  <option value="all">Todos os anos</option>
                  <!-- Os anos serão carregados dinamicamente -->
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="relatorio-tipo" class="form-label filter-label">Tipo de Relatório</label>
                <select class="form-select" id="relatorio-tipo">
                  <option value="consolidado">Consolidado Anual</option>
                  <option value="destinos">Por Destino</option>
                  <option value="situacao">Por Situação</option>
                  <option value="mensal">Mensal Detalhado</option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="relatorio-situacao" class="form-label filter-label">Situação (opcional)</label>
                <select class="form-select" id="relatorio-situacao">
                  <option value="all">Todas as situações</option>
                  <option value="REALIZADO">REALIZADO</option>
                  <option value="CANCELADO">CANCELADO</option>
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-12">
              <div class="d-flex gap-3">
                <button class="btn-primary-custom" id="btn-gerar-relatorio">
                  <i class="fas fa-chart-bar me-2"></i>Gerar Relatório
                </button>
                <button class="btn-secondary-custom" id="btn-export-relatorio">
                  <i class="fas fa-file-pdf me-2"></i>Exportar PDF
                </button>
                <button class="btn-secondary-custom" id="btn-update-relatorio">
                  <i class="fas fa-sync-alt me-2"></i>Atualizar Dados
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Cards de Estatísticas do Relatório -->
        <div class="card-stats-grid">
          <div class="card-stats">
            <i class="fas fa-plane fa-2x" style="color: var(--accent-red);"></i>
            <div class="value" id="relatorio-voos">—</div>
            <div class="label">Total de Voos</div>
            <div class="data-source-info">GitHub</div>
          </div>
          <div class="card-stats">
            <i class="fas fa-clock fa-2x" style="color: var(--secondary-blue);"></i>
            <div class="value" id="relatorio-horas">—</div>
            <div class="label">Horas Voadas</div>
            <div class="data-source-info">GitHub</div>
          </div>
          <div class="card-stats">
            <i class="fas fa-check-circle fa-2x" style="color: var(--secondary-green);"></i>
            <div class="value" id="relatorio-sucesso">—</div>
            <div class="label">Taxa de Sucesso</div>
            <div class="data-source-info">GitHub</div>
          </div>
          <div class="card-stats">
            <i class="fas fa-map-marker-alt fa-2x" style="color: var(--secondary-purple);"></i>
            <div class="value" id="relatorio-destinos">—</div>
            <div class="label">Destinos Únicos</div>
            <div class="data-source-info">GitHub</div>
          </div>
        </div>

        <!-- Gráficos do Relatório -->
        <div class="dashboard-grid">
          <div class="chart-container">
            <div class="chart-header">
              <h4 class="chart-title">Distribuição por Situação</h4>
              <div class="data-source-info">Fonte: GitHub</div>
            </div>
            <div class="chart-wrapper">
              <div id="chart-situacao-relatorio" style="height:100%; width:100%;"></div>
            </div>
          </div>
          <div class="chart-container">
            <div class="chart-header">
              <h4 class="chart-title">Voos por Mês</h4>
              <div class="data-source-info">Fonte: GitHub</div>
            </div>
            <div class="chart-wrapper">
              <div id="chart-meses-relatorio" style="height:100%; width:100%;"></div>
            </div>
          </div>
        </div>

        <!-- Tabela do Relatório -->
        <div class="table-container">
          <div class="table-header">
            <h3 class="table-title">Detalhamento do Relatório</h3>
            <div class="d-flex align-items-center gap-3">
              <span class="current-year-indicator">
                <i class="fas fa-calendar-alt"></i> Período: <span id="relatorios-period">Carregando...</span>
              </span>
              <span class="table-badge" id="relatorio-count">0 voos</span>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th onclick="sortTable('relatorio', 'periodo')">
                    Período <span class="sort-icon">▼</span>
                  </th>
                  <th onclick="sortTable('relatorio', 'voos')">
                    Voos <span class="sort-icon">▼</span>
                  </th>
                  <th onclick="sortTable('relatorio', 'realizados')">
                    Realizados <span class="sort-icon">▼</span>
                  </th>
                  <th onclick="sortTable('relatorio', 'cancelados')">
                    Cancelados <span class="sort-icon">▼</span>
                  </th>
                  <th onclick="sortTable('relatorio', 'horas')">
                    Horas <span class="sort-icon">▼</span>
                  </th>
                  <th onclick="sortTable('relatorio', 'taxa_sucesso')">
                    Taxa Sucesso <span class="sort-icon">▼</span>
                  </th>
                </tr>
              </thead>
              <tbody id="relatorio-table-body">
                <tr><td colspan="6" class="text-center">Carregando dados do GitHub...</td></tr>
              </tbody>
              <tfoot id="relatorio-table-footer">
                <!-- Rodapé carregado via JavaScript -->
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <p>
        <i class="fas fa-database"></i> Dados atualizados automaticamente do 
        <a href="https://github.com/transparencia-mg/voos_oficiais_governador/tree/main/docs/data/normalized" target="_blank" style="color: var(--primary-dark); text-decoration: none; font-weight: 600;">
          <i class="fab fa-github"></i> GitHub
        </a>
      </p>
      <p style="margin-top: 10px; font-size: 0.8rem;">
        © 2024 Governo de Minas Gerais. 
        <a href="https://dados.mg.gov.br" target="_blank" style="color: var(--primary-dark); text-decoration: none; font-weight: 600;">
          <i class="fas fa-external-link-alt"></i> dados.mg.gov.br
        </a>
      </p>
    </div>
  </footer>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // ============================================
    // CONFIGURAÇÃO INICIAL
    // ============================================
    
    const chartInstances = {};
    let sortStates = {
      voos: { column: 'data', direction: 'desc' },
      destinos: { column: 'quantidade', direction: 'desc' },
      relatorio: { column: 'periodo', direction: 'asc' }
    };
    
    // Configuração do GitHub
    const GITHUB_REPO = 'transparencia-mg/voos_oficiais_governador';
    const GITHUB_DATA_PATH = 'docs/data/normalized';
    const GITHUB_API_BASE = 'https://api.github.com';
    
    // Cache de dados
    let dadosCache = {
      voos: [],
      anos: [],
      origens: [],
      destinos: [],
      situacoes: [],
      lastUpdate: null,
      files: []
    };
    
    // Paleta de cores
    const palette = {
      primary: ['#29435A', '#2E5984', '#3A7CA5', '#4F9EC4'],
      accent: ['#B93C42', '#DB233F', '#E5586E', '#EF8A9E'],
      secondary: ['#2E8B57', '#3CB371', '#66CDAA', '#98F5FF'],
      additional: ['#6A5ACD', '#9370DB', '#BA55D3', '#DA70D6']
    };
    
    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
      setupEventListeners();
      setupTooltips();
      loadDataFromGitHub();
      
      // Verificar atualizações a cada 5 minutos
      setInterval(checkForUpdates, 300000);
    });
    
    function setupEventListeners() {
      // Visão Geral
      document.getElementById('btn-apply').addEventListener('click', loadVoosData);
      document.getElementById('btn-clear').addEventListener('click', clearVoosFilters);
      document.getElementById('btn-refresh-data').addEventListener('click', () => loadDataFromGitHub(true));
      
      // Destinos
      document.getElementById('btn-apply-destinos').addEventListener('click', loadDestinosData);
      document.getElementById('btn-clear-destinos').addEventListener('click', clearDestinosFilters);
      
      // Relatórios
      document.getElementById('btn-gerar-relatorio').addEventListener('click', loadRelatorioData);
      document.getElementById('btn-update-relatorio').addEventListener('click', () => loadDataFromGitHub(true));
      
      // Download
      document.getElementById('btn-download-year').addEventListener('click', handleDownload);
      document.getElementById('btn-check-updates').addEventListener('click', checkForUpdates);
      
      // Exportação
      document.getElementById('exportCSV').addEventListener('click', () => exportData('voos'));
      document.getElementById('exportCSV-destinos').addEventListener('click', () => exportData('destinos'));
      
      // Impressão
      document.getElementById('btn-print').addEventListener('click', () => printCurrentTab('Visão Geral de Voos'));
      document.getElementById('btn-print-destinos').addEventListener('click', () => printCurrentTab('Análise de Destinos'));
      document.getElementById('btn-export-relatorio').addEventListener('click', () => printCurrentTab('Relatório de Voos'));
      
      // Compartilhamento
      setupSocialShare();
    }
    
    function setupTooltips() {
      tippy('#btn-refresh-data', {
        content: 'Atualizar dados do GitHub',
        placement: 'top',
        theme: 'light',
        animation: 'scale'
      });
      
      tippy('#btn-check-updates', {
        content: 'Verificar atualizações no GitHub',
        placement: 'top',
        theme: 'light',
        animation: 'scale'
      });
      
      tippy('#githubStatus', {
        content: 'Status da conexão com GitHub',
        placement: 'top',
        theme: 'light',
        animation: 'scale'
      });
    }
    
    function setupSocialShare() {
      document.querySelectorAll('.btn-social').forEach(button => {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          
          const url = encodeURIComponent(window.location.href);
          const title = encodeURIComponent('Painel de Voos Oficiais - Governo de Minas Gerais');
          const text = encodeURIComponent('Confira os dados atualizados de voos oficiais do Governo de MG');
          
          let shareUrl = '';
          
          if (this.classList.contains('btn-facebook')) {
            shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
          } else if (this.classList.contains('btn-twitter')) {
            shareUrl = `https://twitter.com/intent/tweet?url=${url}&text=${text}`;
          } else if (this.classList.contains('btn-linkedin')) {
            shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;
          } else if (this.classList.contains('btn-whatsapp')) {
            shareUrl = `https://wa.me/?text=${text}%20${url}`;
          }
          
          if (shareUrl) {
            window.open(shareUrl, '_blank', 'width=600,height=400');
          }
        });
      });
    }
    
    // ============================================
    // INTEGRAÇÃO COM GITHUB
    // ============================================
    
    async function loadDataFromGitHub(forceRefresh = false) {
      showLoading('Conectando ao GitHub...');
      updateStatus('updating', 'Conectando ao GitHub...');
      
      try {
        // Verificar se precisa atualizar (cache de 1 hora)
        const now = new Date();
        if (!forceRefresh && dadosCache.lastUpdate && 
            (now - dadosCache.lastUpdate) < 3600000 && 
            dadosCache.voos.length > 0) {
          hideLoading();
          updateStatus('online', 'Dados em cache');
          loadFilterOptions();
          loadVoosData();
          return;
        }
        
        // Buscar lista de arquivos
        const filesUrl = `${GITHUB_API_BASE}/repos/${GITHUB_REPO}/contents/${GITHUB_DATA_PATH}`;
        const filesResponse = await fetch(filesUrl);
        
        if (!filesResponse.ok) {
          throw new Error(`GitHub API error: ${filesResponse.status}`);
        }
        
        const files = await filesResponse.json();
        dadosCache.files = files;
        
        // Atualizar lista de arquivos na interface
        updateGitHubFilesList(files);
        
        // Carregar dados de todos os arquivos CSV
        let allVoos = [];
        let progress = 0;
        
        for (const file of files) {
          if (file.name.endsWith('.csv')) {
            updateLoadingProgress(progress, files.length, `Carregando ${file.name}...`);
            
            try {
              const fileData = await loadCSVFromGitHub(file.download_url);
              allVoos = allVoos.concat(fileData);
            } catch (error) {
              console.warn(`Erro ao carregar ${file.name}:`, error);
            }
            
            progress++;
          }
        }
        
        // Processar dados
        dadosCache.voos = processVoosData(allVoos);
        dadosCache.lastUpdate = new Date();
        
        // Extrair opções de filtro
        extractFilterOptions();
        
        // Atualizar interface
        hideLoading();
        updateStatus('online', 'Dados atualizados');
        updateLastUpdateTime();
        
        // Carregar filtros e dados
        loadFilterOptions();
        loadVoosData();
        
        // Atualizar status do GitHub
        updateGitHubStatus('online', 'GitHub Conectado');
        
      } catch (error) {
        console.error('Erro ao carregar dados do GitHub:', error);
        hideLoading();
        updateStatus('offline', 'Erro ao carregar dados');
        updateGitHubStatus('offline', 'Erro de conexão');
        
        // Usar dados mockados como fallback
        useMockData();
      }
    }
    
    async function loadCSVFromGitHub(url) {
      const response = await fetch(url);
      const csvText = await response.text();
      
      return new Promise((resolve, reject) => {
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            resolve(results.data);
          },
          error: (error) => {
            reject(error);
          }
        });
      });
    }
    
    function processVoosData(rawData) {
      // Processar dados brutos
      return rawData.map(voo => ({
        data: voo.data || voo.date || '',
        origem: voo.origem || voo.origin || '',
        destino: voo.destino || voo.destination || '',
        passageiro: voo.passageiro || voo.passenger || '',
        horas_voo: parseFloat(voo.horas_voo || voo.flight_hours || voo.hours || 0),
        situacao: (voo.situacao || voo.status || '').toUpperCase(),
        // Extrair ano da data
        ano: extractYearFromDate(voo.data || voo.date)
      })).filter(voo => voo.data && voo.origem && voo.destino);
    }
    
    function extractYearFromDate(dateStr) {
      if (!dateStr) return '';
      // Tenta extrair ano de diferentes formatos de data
      const match = dateStr.match(/\b(\d{4})\b/);
      return match ? match[1] : '';
    }
    
    function extractFilterOptions() {
      const voos = dadosCache.voos;
      
      // Extrair anos únicos
      dadosCache.anos = [...new Set(voos.map(v => v.ano).filter(Boolean))].sort().reverse();
      
      // Extrair origens únicas
      dadosCache.origens = [...new Set(voos.map(v => v.origem).filter(Boolean))].sort();
      
      // Extrair destinos únicos
      dadosCache.destinos = [...new Set(voos.map(v => v.destino).filter(Boolean))].sort();
      
      // Extrair situações únicas
      dadosCache.situacoes = [...new Set(voos.map(v => v.situacao).filter(Boolean))].sort();
    }
    
    function loadFilterOptions() {
      // Carregar anos
      const yearSelects = document.querySelectorAll('select[id$="ano"], select[id*="year"]');
      yearSelects.forEach(select => {
        const currentValue = select.value;
        select.innerHTML = '<option value="all">Todos os anos</option>';
        
        dadosCache.anos.forEach(ano => {
          const option = document.createElement('option');
          option.value = ano;
          option.textContent = ano;
          if (ano === '2024') option.selected = true;
          select.appendChild(option);
        });
        
        // Restaurar valor anterior se possível
        if (currentValue && dadosCache.anos.includes(currentValue)) {
          select.value = currentValue;
        }
      });
      
      // Carregar origens
      const origemSelects = document.querySelectorAll('select[id*="origem"]');
      origemSelects.forEach(select => {
        const currentValue = select.value;
        select.innerHTML = '<option value="all">Todas as origens</option>';
        
        dadosCache.origens.forEach(origem => {
          const option = document.createElement('option');
          option.value = origem;
          option.textContent = origem;
          select.appendChild(option);
        });
        
        if (currentValue && dadosCache.origens.includes(currentValue)) {
          select.value = currentValue;
        }
      });
      
      // Carregar destinos
      const destinoSelects = document.querySelectorAll('select[id*="destino"]:not([id*="situacao"])');
      destinoSelects.forEach(select => {
        const currentValue = select.value;
        select.innerHTML = '<option value="all">Todos os destinos</option>';
        
        dadosCache.destinos.forEach(destino => {
          const option = document.createElement('option');
          option.value = destino;
          option.textContent = destino;
          select.appendChild(option);
        });
        
        if (currentValue && dadosCache.destinos.includes(currentValue)) {
          select.value = currentValue;
        }
      });
      
      // Carregar situações
      const situacaoSelects = document.querySelectorAll('select[id*="situacao"]');
      situacaoSelects.forEach(select => {
        const currentValue = select.value;
        select.innerHTML = '<option value="all">Todas as situações</option>';
        
        dadosCache.situacoes.forEach(situacao => {
          const option = document.createElement('option');
          option.value = situacao;
          option.textContent = situacao;
          select.appendChild(option);
        });
        
        if (currentValue && dadosCache.situacoes.includes(currentValue)) {
          select.value = currentValue;
        }
      });
    }
    
    function updateGitHubFilesList(files) {
      const filesList = document.getElementById('github-files');
      if (!filesList) return;
      
      // Ordenar arquivos por nome (anos mais recentes primeiro)
      const sortedFiles = files
        .filter(file => file.name.endsWith('.csv'))
        .sort((a, b) => b.name.localeCompare(a.name));
      
      filesList.innerHTML = '';
      
      sortedFiles.forEach(file => {
        const sizeMB = (file.size / 1024 / 1024).toFixed(2);
        const item = document.createElement('div');
        item.className = 'list-group-item';
        item.innerHTML = `
          <div class="d-flex w-100 justify-content-between">
            <h6 class="mb-1">
              <i class="fas fa-file-csv text-success me-2"></i>
              ${file.name}
            </h6>
            <small class="text-muted">${sizeMB} MB</small>
          </div>
          <p class="mb-1">${file.path}</p>
          <small>Última atualização: ${new Date(file.updated_at || file.created_at).toLocaleDateString('pt-BR')}</small>
          <div class="mt-2">
            <button class="btn btn-sm btn-outline-primary me-2" onclick="downloadGitHubFile('${file.download_url}', '${file.name}')">
              <i class="fas fa-download"></i> Baixar
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="previewGitHubFile('${file.download_url}')">
              <i class="fas fa-eye"></i> Pré-visualizar
            </button>
          </div>
        `;
        filesList.appendChild(item);
      });
      
      if (sortedFiles.length === 0) {
        filesList.innerHTML = '<div class="list-group-item text-center">Nenhum arquivo CSV encontrado</div>';
      }
    }
    
    async function checkForUpdates() {
      try {
        updateStatus('updating', 'Verificando atualizações...');
        
        const filesUrl = `${GITHUB_API_BASE}/repos/${GITHUB_REPO}/contents/${GITHUB_DATA_PATH}`;
        const response = await fetch(filesUrl, {
          headers: {
            'If-None-Match': dadosCache.lastUpdate ? dadosCache.lastUpdate.getTime() : ''
          }
        });
        
        if (response.status === 304) {
          // Não há atualizações
          updateStatus('online', 'Dados atualizados');
          showNotification('Os dados já estão atualizados!', 'info');
          return;
        }
        
        if (response.ok) {
          // Há atualizações disponíveis
          const files = await response.json();
          const hasNewFiles = JSON.stringify(files) !== JSON.stringify(dadosCache.files);
          
          if (hasNewFiles) {
            showNotification('Novos dados disponíveis! Atualizando...', 'info');
            loadDataFromGitHub(true);
          } else {
            updateStatus('online', 'Dados atualizados');
            showNotification('Os dados já estão atualizados!', 'info');
          }
        }
      } catch (error) {
        console.error('Erro ao verificar atualizações:', error);
        updateStatus('offline', 'Erro ao verificar');
      }
    }
    
    // ============================================
    // FUNÇÕES DE UTILITÁRIOS
    // ============================================
    
    function updateStatus(status, text) {
      const statusElement = document.getElementById('updateStatus');
      const textElement = document.getElementById('updateStatusText');
      
      if (statusElement && textElement) {
        statusElement.className = `update-status ${status}`;
        textElement.textContent = text;
      }
    }
    
    function updateGitHubStatus(status, text) {
      const statusElement = document.getElementById('githubStatus');
      const textElement = document.getElementById('githubStatusText');
      
      if (statusElement && textElement) {
        statusElement.className = `update-status ${status}`;
        textElement.textContent = text;
      }
    }
    
    function updateLastUpdateTime() {
      const timeElement = document.getElementById('lastUpdateTime');
      if (timeElement && dadosCache.lastUpdate) {
        const now = new Date();
        const diffMinutes = Math.floor((now - dadosCache.lastUpdate) / 60000);
        
        if (diffMinutes < 1) {
          timeElement.textContent = 'Agora';
        } else if (diffMinutes < 60) {
          timeElement.textContent = `Há ${diffMinutes} min`;
        } else {
          const diffHours = Math.floor(diffMinutes / 60);
          timeElement.textContent = `Há ${diffHours} h`;
        }
      }
    }
    
    function showLoading(text = 'Carregando...') {
      const overlay = document.getElementById('loadingOverlay');
      const textElement = document.getElementById('loadingText');
      
      if (overlay) overlay.style.display = 'flex';
      if (textElement) textElement.textContent = text;
    }
    
    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.style.display = 'none';
    }
    
    function updateLoadingProgress(current, total, text) {
      const progressElement = document.getElementById('loadingProgress');
      const textElement = document.getElementById('loadingText');
      
      if (progressElement) {
        const percentage = Math.round((current / total) * 100);
        progressElement.style.width = `${percentage}%`;
      }
      
      if (textElement) {
        textElement.textContent = text;
      }
    }
    
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      `;
      
      notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 5000);
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '';
      
      // Tentar converter diferentes formatos de data
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) {
          // Se falhar, retornar a string original
          return dateStr;
        }
        return date.toLocaleDateString('pt-BR');
      } catch {
        return dateStr;
      }
    }
    
    function formatHoras(horas) {
      if (!horas && horas !== 0) return '—';
      const horasInt = Math.floor(horas);
      const minutos = Math.round((horas - horasInt) * 60);
      return `${horasInt}h${minutos > 0 ? ` ${minutos}m` : ''}`;
    }
    
    function formatCurrency(valor) {
      if (!valor && valor !== 0) return '—';
      return new Intl.NumberFormat('pt-BR', { 
        style: 'currency', 
        currency: 'BRL'
      }).format(valor);
    }
    
    // ============================================
    // FUNÇÕES PARA DADOS DE FALLBACK (MOCK)
    // ============================================
    
    function useMockData() {
      // Dados mockados para quando o GitHub estiver offline
      const mockVoos = [
        { data: '2024-03-15', origem: 'CNF', destino: 'GRU', passageiro: 'João Silva', horas_voo: 1.5, situacao: 'REALIZADO', ano: '2024' },
        { data: '2024-03-18', origem: 'CNF', destino: 'GIG', passageiro: 'Maria Oliveira', horas_voo: 1.2, situacao: 'REALIZADO', ano: '2024' },
        { data: '2024-03-22', origem: 'UDI', destino: 'BSB', passageiro: 'Carlos Santos', horas_voo: 2.0, situacao: 'CANCELADO', ano: '2024' },
        { data: '2024-02-10', origem: 'CNF', destino: 'GRU', passageiro: 'Ana Costa', horas_voo: 1.5, situacao: 'REALIZADO', ano: '2024' },
        { data: '2023-12-05', origem: 'CNF', destino: 'VIX', passageiro: 'Roberto Alves', horas_voo: 1.8, situacao: 'REALIZADO', ano: '2023' },
        { data: '2023-11-20', origem: 'GRU', destino: 'BSB', passageiro: 'Patrícia Lima', horas_voo: 1.8, situacao: 'REALIZADO', ano: '2023' }
      ];
      
      dadosCache.voos = mockVoos;
      dadosCache.anos = ['2024', '2023'];
      dadosCache.origens = ['CNF', 'UDI', 'GRU'];
      dadosCache.destinos = ['GRU', 'GIG', 'BSB', 'VIX'];
      dadosCache.situacoes = ['REALIZADO', 'CANCELADO'];
      dadosCache.lastUpdate = new Date();
      
      loadFilterOptions();
      loadVoosData();
      showNotification('Usando dados de exemplo (GitHub offline)', 'warning');
    }
    
    // ============================================
    // VISÃO GERAL (VOOS)
    // ============================================
    
    function loadVoosData() {
      const ano = document.getElementById('filter-ano').value;
      const origem = document.getElementById('filter-origem').value;
      const destino = document.getElementById('filter-destino').value;
      const situacao = document.getElementById('filter-situacao').value;
      
      let filteredData = [...dadosCache.voos];
      
      if (ano !== 'all') {
        filteredData = filteredData.filter(v => v.ano === ano);
      }
      
      if (origem !== 'all') {
        filteredData = filteredData.filter(v => v.origem === origem);
      }
      
      if (destino !== 'all') {
        filteredData = filteredData.filter(v => v.destino === destino);
      }
      
      if (situacao !== 'all') {
        filteredData = filteredData.filter(v => v.situacao === situacao);
      }
      
      // Ordenar por data (decrescente por padrão)
      filteredData.sort((a, b) => b.data.localeCompare(a.data));
      
      renderVoosTable(filteredData);
      renderVoosCharts(filteredData);
      updateVoosStatistics(filteredData);
      
      // Atualizar contador
      document.getElementById('voos-count').textContent = `${filteredData.length} voos`;
      document.getElementById('table-year').textContent = ano === 'all' ? 'Todos' : ano;
    }
    
    function renderVoosTable(data) {
      const tableBody = document.getElementById('voos-table-body');
      const tableFooter = document.getElementById('voos-table-footer');
      
      if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum voo encontrado com os filtros aplicados</td></tr>';
        tableFooter.innerHTML = '';
        return;
      }
      
      let tableHTML = '';
      let totalHoras = 0;
      let realizados = 0;
      
      data.forEach(item => {
        tableHTML += `
          <tr>
            <td>${formatDate(item.data)}</td>
            <td>${item.origem}</td>
            <td>${item.destino}</td>
            <td>${item.passageiro}</td>
            <td>${formatHoras(item.horas_voo)}</td>
            <td>
              <span class="badge-status ${item.situacao === 'REALIZADO' ? 'badge-realizado' : 'badge-cancelado'}">
                <i class="fas ${item.situacao === 'REALIZADO' ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                ${item.situacao}
              </span>
            </td>
          </tr>
        `;
        
        totalHoras += item.horas_voo;
        if (item.situacao === 'REALIZADO') realizados++;
      });
      
      tableBody.innerHTML = tableHTML;
      tableFooter.innerHTML = `
        <tr class="table-footer">
          <td colspan="4"><strong>TOTAL</strong></td>
          <td><strong>${formatHoras(totalHoras)}</strong></td>
          <td><strong>${realizados}/${data.length} realizados</strong></td>
        </tr>
      `;
    }
    
    function renderVoosCharts(data) {
      if (data.length === 0) {
        // Gráficos vazios
        Plotly.newPlot('chart-destinos', [{
          x: ['Sem dados'],
          y: [0],
          type: 'bar',
          marker: { color: palette.primary[0] }
        }], {
          title: '',
          margin: { t: 10, r: 30, b: 80, l: 60 },
          paper_bgcolor: 'transparent',
          plot_bgcolor: 'transparent'
        });
        
        Plotly.newPlot('chart-meses', [{
          x: ['Sem dados'],
          y: [0],
          type: 'scatter',
          mode: 'lines+markers',
          line: { color: palette.secondary[0], width: 3 }
        }], {
          title: '',
          margin: { t: 10, r: 30, b: 50, l: 60 },
          paper_bgcolor: 'transparent',
          plot_bgcolor: 'transparent'
        });
        return;
      }
      
      // Gráfico de destinos
      const destinosCount = {};
      data.forEach(item => {
        destinosCount[item.destino] = (destinosCount[item.destino] || 0) + 1;
      });
      
      const destinosArray = Object.entries(destinosCount)
        .map(([destino, quantidade]) => ({ destino, quantidade }))
        .sort((a, b) => b.quantidade - a.quantidade)
        .slice(0, 8);
      
      const destinosTrace = {
        x: destinosArray.map(d => d.destino.length > 10 ? d.destino.substring(0, 10) + '...' : d.destino),
        y: destinosArray.map(d => d.quantidade),
        type: 'bar',
        marker: { color: palette.primary[0] }
      };
      
      Plotly.newPlot('chart-destinos', [destinosTrace], {
        title: '',
        margin: { t: 10, r: 30, b: 80, l: 60 },
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent'
      });
      
      // Gráfico por mês
      const mesesCount = {};
      data.forEach(item => {
        try {
          const date = new Date(item.data);
          if (!isNaN(date.getTime())) {
            const mes = date.toLocaleDateString('pt-BR', { month: 'short' });
            mesesCount[mes] = (mesesCount[mes] || 0) + 1;
          }
        } catch (e) {
          // Ignorar datas inválidas
        }
      });
      
      const mesesOrdenados = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
      const mesesData = mesesOrdenados.map(mes => ({
        mes,
        quantidade: mesesCount[mes] || 0
      }));
      
      const mesesTrace = {
        x: mesesData.map(m => m.mes),
        y: mesesData.map(m => m.quantidade),
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: palette.secondary[0], width: 3 },
        marker: { color: palette.secondary[0], size: 8 }
      };
      
      Plotly.newPlot('chart-meses', [mesesTrace], {
        title: '',
        margin: { t: 10, r: 30, b: 50, l: 60 },
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent'
      });
    }
    
    function updateVoosStatistics(data) {
      const totalVoos = data.length;
      const totalHoras = data.reduce((sum, item) => sum + (item.horas_voo || 0), 0);
      const totalPassageiros = new Set(data.map(item => item.passageiro)).size;
      const destinosUnicos = new Set(data.map(item => item.destino)).size;
      const realizados = data.filter(item => item.situacao === 'REALIZADO').length;
      
      document.getElementById('card-voos').textContent = totalVoos.toLocaleString('pt-BR');
      document.getElementById('card-horas').textContent = formatHoras(totalHoras);
      document.getElementById('card-pass').textContent = totalPassageiros.toLocaleString('pt-BR');
      document.getElementById('card-destinos').textContent = destinosUnicos;
      
      // Atualizar fonte dos dados
      document.getElementById('card-voos-source').textContent = `Fonte: GitHub`;
      document.getElementById('card-horas-source').textContent = `Realizados: ${realizados}`;
      document.getElementById('card-pass-source').textContent = `Únicos: ${totalPassageiros}`;
      document.getElementById('card-destinos-source').textContent = `Distintos: ${destinosUnicos}`;
    }
    
    function clearVoosFilters() {
      document.getElementById('filter-ano').value = 'all';
      document.getElementById('filter-origem').value = 'all';
      document.getElementById('filter-destino').value = 'all';
      document.getElementById('filter-situacao').value = 'all';
      loadVoosData();
    }
    
    // ============================================
    // DESTINOS
    // ============================================
    
    function loadDestinosData() {
      const ano = document.getElementById('destinos-ano').value;
      const destino = document.getElementById('destinos-destino').value;
      const situacao = document.getElementById('destinos-situacao').value;
      
      let filteredData = [...dadosCache.voos];
      
      if (ano !== 'all') {
        filteredData = filteredData.filter(v => v.ano === ano);
      }
      
      if (destino !== 'all') {
        filteredData = filteredData.filter(v => v.destino === destino);
      }
      
      if (situacao !== 'all') {
        filteredData = filteredData.filter(v => v.situacao === situacao);
      }
      
      // Agrupar por destino
      const destinosMap = {};
      filteredData.forEach(voo => {
        if (!destinosMap[voo.destino]) {
          destinosMap[voo.destino] = {
            destino: voo.destino,
            quantidade: 0,
            horas_totais: 0,
            realizados: 0,
            cancelados: 0
          };
        }
        
        destinosMap[voo.destino].quantidade++;
        destinosMap[voo.destino].horas_totais += voo.horas_voo || 0;
        
        if (voo.situacao === 'REALIZADO') {
          destinosMap[voo.destino].realizados++;
        } else if (voo.situacao === 'CANCELADO') {
          destinosMap[voo.destino].cancelados++;
        }
      });
      
      // Converter para array e calcular taxa de sucesso
      const destinosArray = Object.values(destinosMap).map(d => ({
        ...d,
        taxa_sucesso: d.quantidade > 0 ? (d.realizados / d.quantidade) * 100 : 0
      }));
      
      // Ordenar por quantidade (decrescente)
      destinosArray.sort((a, b) => b.quantidade - a.quantidade);
      
      renderDestinosTable(destinosArray);
      renderDestinosCharts(filteredData, destinosArray);
      
      // Atualizar contadores
      document.getElementById('destinos-count').textContent = `${destinosArray.length} destinos`;
      document.getElementById('destinos-period').textContent = ano === 'all' ? 'Todos' : ano;
    }
    
    function renderDestinosTable(data) {
      const tableBody = document.getElementById('destinos-table-body');
      const tableFooter = document.getElementById('destinos-table-footer');
      
      if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum destino encontrado</td></tr>';
        tableFooter.innerHTML = '';
        return;
      }
      
      let tableHTML = '';
      let totals = { quantidade: 0, horas_totais: 0, realizados: 0, cancelados: 0 };
      
      data.forEach(item => {
        tableHTML += `
          <tr>
            <td>${item.destino}</td>
            <td>${item.quantidade.toLocaleString('pt-BR')}</td>
            <td>${formatHoras(item.horas_totais)}</td>
            <td>${item.realizados.toLocaleString('pt-BR')}</td>
            <td>${item.cancelados.toLocaleString('pt-BR')}</td>
            <td>${item.taxa_sucesso.toFixed(1)}%</td>
          </tr>
        `;
        
        totals.quantidade += item.quantidade;
        totals.horas_totais += item.horas_totais;
        totals.realizados += item.realizados;
        totals.cancelados += item.cancelados;
      });
      
      const taxaSucessoTotal = totals.quantidade > 0 ? (totals.realizados / totals.quantidade) * 100 : 0;
      
      tableBody.innerHTML = tableHTML;
      tableFooter.innerHTML = `
        <tr class="table-footer">
          <td><strong>TOTAL</strong></td>
          <td><strong>${totals.quantidade.toLocaleString('pt-BR')}</strong></td>
          <td><strong>${formatHoras(totals.horas_totais)}</strong></td>
          <td><strong>${totals.realizados.toLocaleString('pt-BR')}</strong></td>
          <td><strong>${totals.cancelados.toLocaleString('pt-BR')}</strong></td>
          <td><strong>${taxaSucessoTotal.toFixed(1)}%</strong></td>
        </tr>
      `;
    }
    
    function renderDestinosCharts(voosData, destinosData) {
      if (voosData.length === 0) {
        // Gráficos vazios
        Plotly.newPlot('chart-situacao-destinos', [{
          labels: ['Sem dados'],
          values: [100],
          type: 'pie',
          marker: { colors: [palette.primary[0]] }
        }], {
          title: '',
          paper_bgcolor: 'transparent',
          plot_bgcolor: 'transparent'
        });
        
        Plotly.newPlot('chart-top-destinos', [{
          x: ['Sem dados'],
          y: [0],
          type: 'bar',
          marker: { color: palette.accent[0] }
        }], {
          title: '',
          margin: { t: 10, r: 30, b: 80, l: 60 },
          paper_bgcolor: 'transparent',
          plot_bgcolor: 'transparent'
        });
        return;
      }
      
      // Gráfico de situação
      const situacaoCount = voosData.reduce((acc, voo) => {
        acc[voo.situacao] = (acc[voo.situacao] || 0) + 1;
        return acc;
      }, {});
      
      const situacaoTrace = {
        labels: Object.keys(situacaoCount),
        values: Object.values(situacaoCount),
        type: 'pie',
        marker: { colors: [palette.secondary[0], palette.accent[0]] }
      };
      
      Plotly.newPlot('chart-situacao-destinos', [situacaoTrace], {
        title: '',
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent'
      });
      
      // Gráfico de top destinos (top 10)
      const topDestinos = destinosData.slice(0, 10);
      const topDestinosTrace = {
        x: topDestinos.map(d => d.destino.length > 10 ? d.destino.substring(0, 10) + '...' : d.destino),
        y: topDestinos.map(d => d.quantidade),
        type: 'bar',
        marker: { color: palette.accent[0] }
      };
      
      Plotly.newPlot('chart-top-destinos', [topDestinosTrace], {
        title: '',
        margin: { t: 10, r: 30, b: 80, l: 60 },
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent'
      });
    }
    
    function clearDestinosFilters() {
      document.getElementById('destinos-ano').value = 'all';
      document.getElementById('destinos-destino').value = 'all';
      document.getElementById('destinos-situacao').value = 'all';
      loadDestinosData();
    }
    
    // ============================================
    // RELATÓRIOS
    // ============================================
    
    function loadRelatorioData() {
      const ano = document.getElementById('relatorio-ano').value;
      const tipo = document.getElementById('relatorio-tipo').value;
      const situacao = document.getElementById('relatorio-situacao').value;
      
      let filteredData = [...dadosCache.voos];
      
      if (ano !== 'all') {
        filteredData = filteredData.filter(v => v.ano === ano);
      }
      
      if (situacao !== 'all') {
        filteredData = filteredData.filter(v => v.situacao === situacao);
      }
      
      renderRelatorioTable(filteredData, tipo);
      renderRelatorioCharts(filteredData);
      updateRelatorioStatistics(filteredData);
      
      document.getElementById('relatorios-period').textContent = ano === 'all' ? 'Todos' : ano;
      document.getElementById('relatorio-count').textContent = `${filteredData.length} voos`;
    }
    
    function renderRelatorioTable(data, tipo) {
      const tableBody = document.getElementById('relatorio-table-body');
      const tableFooter = document.getElementById('relatorio-table-footer');
      
      if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum dado para exibir</td></tr>';
        tableFooter.innerHTML = '';
        return;
      }
      
      let tableHTML = '';
      let tableData = [];
      let totals = { voos: 0, realizados: 0, cancelados: 0, horas: 0 };
      
      if (tipo === 'mensal') {
        // Agrupar por mês
        const mesesMap = {};
        
        data.forEach(voo => {
          try {
            const date = new Date(voo.data);
            if (!isNaN(date.getTime())) {
              const mesKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
              const mesLabel = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
              
              if (!mesesMap[mesKey]) {
                mesesMap[mesKey] = {
                  periodo: mesLabel,
                  voos: 0,
                  realizados: 0,
                  cancelados: 0,
                  horas: 0
                };
              }
              
              mesesMap[mesKey].voos++;
              mesesMap[mesKey].horas += voo.horas_voo || 0;
              
              if (voo.situacao === 'REALIZADO') {
                mesesMap[mesKey].realizados++;
              } else if (voo.situacao === 'CANCELADO') {
                mesesMap[mesKey].cancelados++;
              }
            }
          } catch (e) {
            // Ignorar datas inválidas
          }
        });
        
        tableData = Object.values(mesesMap)
          .map(m => ({
            ...m,
            taxa_sucesso: m.voos > 0 ? (m.realizados / m.voos) * 100 : 0
          }))
          .sort((a, b) => a.periodo.localeCompare(b.periodo));
          
      } else if (tipo === 'destinos') {
        // Agrupar por destino
        const destinosMap = {};
        
        data.forEach(voo => {
          if (!destinosMap[voo.destino]) {
            destinosMap[voo.destino] = {
              periodo: voo.destino,
              voos: 0,
              realizados: 0,
              cancelados: 0,
              horas: 0
            };
          }
          
          destinosMap[voo.destino].voos++;
          destinosMap[voo.destino].horas += voo.horas_voo || 0;
          
          if (voo.situacao === 'REALIZADO') {
            destinosMap[voo.destino].realizados++;
          } else if (voo.situacao === 'CANCELADO') {
            destinosMap[voo.destino].cancelados++;
          }
        });
        
        tableData = Object.values(destinosMap)
          .map(d => ({
            ...d,
            taxa_sucesso: d.voos > 0 ? (d.realizados / d.voos) * 100 : 0
          }))
          .sort((a, b) => b.voos - a.voos)
          .slice(0, 20); // Limitar a 20 destinos
          
      } else {
        // Consolidado anual
        const anosMap = {};
        
        data.forEach(voo => {
          if (!anosMap[voo.ano]) {
            anosMap[voo.ano] = {
              periodo: voo.ano,
              voos: 0,
              realizados: 0,
              cancelados: 0,
              horas: 0
            };
          }
          
          anosMap[voo.ano].voos++;
          anosMap[voo.ano].horas += voo.horas_voo || 0;
          
          if (voo.situacao === 'REALIZADO') {
            anosMap[voo.ano].realizados++;
          } else if (voo.situacao === 'CANCELADO') {
            anosMap[voo.ano].cancelados++;
          }
        });
        
        tableData = Object.values(anosMap)
          .map(a => ({
            ...a,
            taxa_sucesso: a.voos > 0 ? (a.realizados / a.voos) * 100 : 0
          }))
          .sort((a, b) => b.periodo.localeCompare(a.periodo));
      }
      
      // Gerar tabela HTML
      tableData.forEach(item => {
        tableHTML += `
          <tr>
            <td>${item.periodo}</td>
            <td>${item.voos.toLocaleString('pt-BR')}</td>
            <td>${item.realizados.toLocaleString('pt-BR')}</td>
            <td>${item.cancelados.toLocaleString('pt-BR')}</td>
            <td>${formatHoras(item.horas)}</td>
            <td>${item.taxa_sucesso.toFixed(1)}%</td>
          </tr>
        `;
        
        totals.voos += item.voos;
        totals.realizados += item.realizados;
        totals.cancelados += item.cancelados;
        totals.horas += item.horas;
      });
      
      const taxaSucessoTotal = totals.voos > 0 ? (totals.realizados / totals.voos) * 100 : 0;
      
      tableBody.innerHTML = tableHTML || '<tr><td colspan="6" class="text-center">Nenhum dado para exibir</td></tr>';
      tableFooter.innerHTML = tableData.length > 0 ? `
        <tr class="table-footer">
          <td><strong>TOTAL</strong></td>
          <td><strong>${totals.voos.toLocaleString('pt-BR')}</strong></td>
          <td><strong>${totals.realizados.toLocaleString('pt-BR')}</strong></td>
          <td><strong>${totals.cancelados.toLocaleString('pt-BR')}</strong></td>
          <td><strong>${formatHoras(totals.horas)}</strong></td>
          <td><strong>${taxaSucessoTotal.toFixed(1)}%</strong></td>
        </tr>
      ` : '';
    }
    
    function renderRelatorioCharts(data) {
      if (data.length === 0) {
        // Gráficos vazios
        Plotly.newPlot('chart-situacao-relatorio', [{
          labels: ['Sem dados'],
          values: [100],
          type: 'pie',
          marker: { colors: [palette.primary[0]] }
        }], {
          title: '',
          paper_bgcolor: 'transparent',
          plot_bgcolor: 'transparent'
        });
        
        Plotly.newPlot('chart-meses-relatorio', [{
          x: ['Sem dados'],
          y: [0],
          type: 'bar',
          marker: { color: palette.secondary[0] }
        }], {
          title: '',
          margin: { t: 10, r: 30, b: 50, l: 60 },
          paper_bgcolor: 'transparent',
          plot_bgcolor: 'transparent'
        });
        return;
      }
      
      // Gráfico de situação
      const situacaoCount = data.reduce((acc, voo) => {
        acc[voo.situacao] = (acc[voo.situacao] || 0) + 1;
        return acc;
      }, {});
      
      const situacaoTrace = {
        labels: Object.keys(situacaoCount),
        values: Object.values(situacaoCount),
        type: 'pie',
        marker: { colors: [palette.secondary[0], palette.accent[0]] }
      };
      
      Plotly.newPlot('chart-situacao-relatorio', [situacaoTrace], {
        title: '',
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent'
      });
      
      // Gráfico por mês
      const mesesCount = {};
      data.forEach(item => {
        try {
          const date = new Date(item.data);
          if (!isNaN(date.getTime())) {
            const mes = date.toLocaleDateString('pt-BR', { month: 'short' });
            mesesCount[mes] = (mesesCount[mes] || 0) + 1;
          }
        } catch (e) {
          // Ignorar datas inválidas
        }
      });
      
      const mesesOrdenados = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
      const mesesData = mesesOrdenados.map(mes => ({
        mes,
        quantidade: mesesCount[mes] || 0
      }));
      
      const mesesTrace = {
        x: mesesData.map(m => m.mes),
        y: mesesData.map(m => m.quantidade),
        type: 'bar',
        marker: { color: palette.secondary[0] }
      };
      
      Plotly.newPlot('chart-meses-relatorio', [mesesTrace], {
        title: '',
        margin: { t: 10, r: 30, b: 50, l: 60 },
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent'
      });
    }
    
    function updateRelatorioStatistics(data) {
      const totalVoos = data.length;
      const totalHoras = data.reduce((sum, item) => sum + (item.horas_voo || 0), 0);
      const realizados = data.filter(item => item.situacao === 'REALIZADO').length;
      const destinosUnicos = new Set(data.map(item => item.destino)).size;
      const taxaSucesso = totalVoos > 0 ? (realizados / totalVoos) * 100 : 0;
      
      document.getElementById('relatorio-voos').textContent = totalVoos.toLocaleString('pt-BR');
      document.getElementById('relatorio-horas').textContent = formatHoras(totalHoras);
      document.getElementById('relatorio-sucesso').textContent = `${taxaSucesso.toFixed(1)}%`;
      document.getElementById('relatorio-destinos').textContent = destinosUnicos;
    }
    
    // ============================================
    // DOWNLOAD E EXPORTAÇÃO
    // ============================================
    
    async function handleDownload() {
      const ano = document.getElementById('download-year').value;
      const formato = document.getElementById('download-format').value;
      const comFiltros = document.getElementById('download-filter').value === 'yes';
      
      showLoading('Preparando download...');
      
      try {
        let dataToDownload;
        
        if (comFiltros) {
          // Usar dados filtrados da aba atual
          const activeTab = document.querySelector('.tab-pane.active').id;
          
          if (activeTab === 'overview') {
            const anoFilter = document.getElementById('filter-ano').value;
            const origemFilter = document.getElementById('filter-origem').value;
            const destinoFilter = document.getElementById('filter-destino').value;
            const situacaoFilter = document.getElementById('filter-situacao').value;
            
            dataToDownload = dadosCache.voos.filter(voo => {
              if (anoFilter !== 'all' && voo.ano !== anoFilter) return false;
              if (origemFilter !== 'all' && voo.origem !== origemFilter) return false;
              if (destinoFilter !== 'all' && voo.destino !== destinoFilter) return false;
              if (situacaoFilter !== 'all' && voo.situacao !== situacaoFilter) return false;
              return true;
            });
          } else {
            dataToDownload = dadosCache.voos;
          }
        } else {
          // Usar todos os dados
          dataToDownload = dadosCache.voos;
        }
        
        // Filtrar por ano se necessário
        if (ano !== 'all') {
          dataToDownload = dataToDownload.filter(voo => voo.ano === ano);
        }
        
        // Exportar no formato selecionado
        switch(formato) {
          case 'csv':
            exportToCSV(dataToDownload, `voos_oficiais_${ano === 'all' ? 'todos' : ano}.csv`);
            break;
          case 'json':
            exportToJSON(dataToDownload, `voos_oficiais_${ano === 'all' ? 'todos' : ano}.json`);
            break;
          case 'xlsx':
          case 'pdf':
            // Para Excel e PDF, mostramos uma mensagem
            showNotification(`Formato ${formato.toUpperCase()} seria gerado com ${dataToDownload.length} registros`, 'info');
            break;
        }
        
        hideLoading();
        showNotification(`Download preparado com ${dataToDownload.length} registros`, 'success');
        
      } catch (error) {
        hideLoading();
        showNotification('Erro ao preparar download', 'danger');
        console.error('Erro no download:', error);
      }
    }
    
    function exportToCSV(data, filename) {
      if (data.length === 0) {
        showNotification('Nenhum dado para exportar', 'warning');
        return;
      }
      
      const headers = ['data', 'origem', 'destino', 'passageiro', 'horas_voo', 'situacao', 'ano'];
      const csvRows = [];
      
      // Cabeçalho
      csvRows.push(headers.join(','));
      
      // Dados
      data.forEach(item => {
        const row = headers.map(header => {
          const value = item[header] || '';
          // Escapar vírgulas e aspas
          if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
            return `"${value.replace(/"/g, '""')}"`;
          }
          return value;
        });
        csvRows.push(row.join(','));
      });
      
      const csvContent = csvRows.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }
    
    function exportToJSON(data, filename) {
      const jsonContent = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonContent], { type: 'application/json' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }
    
    function exportData(tipo) {
      let data, filename;
      
      switch(tipo) {
        case 'voos':
          data = dadosCache.voos;
          filename = `voos_oficiais_${new Date().toISOString().slice(0,10)}.csv`;
          break;
          
        case 'destinos':
          // Para destinos, precisamos calcular os dados agrupados
          const destinosMap = {};
          dadosCache.voos.forEach(voo => {
            if (!destinosMap[voo.destino]) {
              destinosMap[voo.destino] = {
                destino: voo.destino,
                quantidade: 0,
                horas_totais: 0,
                realizados: 0,
                cancelados: 0
              };
            }
            
            destinosMap[voo.destino].quantidade++;
            destinosMap[voo.destino].horas_totais += voo.horas_voo || 0;
            
            if (voo.situacao === 'REALIZADO') {
              destinosMap[voo.destino].realizados++;
            } else if (voo.situacao === 'CANCELADO') {
              destinosMap[voo.destino].cancelados++;
            }
          });
          
          data = Object.values(destinosMap).map(d => ({
            ...d,
            taxa_sucesso: d.quantidade > 0 ? (d.realizados / d.quantidade) * 100 : 0
          }));
          
          filename = `analise_destinos_${new Date().toISOString().slice(0,10)}.csv`;
          break;
      }
      
      exportToCSV(data, filename);
      showNotification('Dados exportados com sucesso!', 'success');
    }
    
    function downloadFromGitHub(type) {
      if (type === 'raw') {
        // Baixar arquivo CSV original do GitHub
        const csvFiles = dadosCache.files.filter(file => file.name.endsWith('.csv'));
        if (csvFiles.length > 0) {
          const latestFile = csvFiles.sort((a, b) => 
            b.name.localeCompare(a.name)
          )[0];
          
          window.open(latestFile.download_url, '_blank');
          showNotification(`Baixando ${latestFile.name}...`, 'info');
        } else {
          showNotification('Nenhum arquivo CSV encontrado', 'warning');
        }
      }
    }
    
    async function downloadGitHubFile(url, filename) {
      try {
        const response = await fetch(url);
        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        
        link.href = downloadUrl;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(downloadUrl);
        
        showNotification(`Download de ${filename} iniciado`, 'success');
      } catch (error) {
        showNotification(`Erro ao baixar ${filename}`, 'danger');
        console.error('Erro no download:', error);
      }
    }
    
    async function previewGitHubFile(url) {
      try {
        const response = await fetch(url);
        const text = await response.text();
        const lines = text.split('\n').slice(0, 11); // Primeiras 10 linhas + cabeçalho
        
        const preview = lines.join('\n');
        alert(`Pré-visualização (primeiras 10 linhas):\n\n${preview}`);
      } catch (error) {
        showNotification('Erro ao pré-visualizar arquivo', 'danger');
      }
    }
    
    // ============================================
    // SISTEMA DE ORDENAÇÃO
    // ============================================
    
    function sortTable(tableType, column) {
      // Implementação básica - em produção, você pode querer implementar
      // uma ordenação mais sofisticada para cada tipo de tabela
      showNotification(`Ordenação por ${column} será implementada`, 'info');
    }
    
    // ============================================
    // IMPRESSÃO
    // ============================================
    
    function printCurrentTab(title) {
      const activeTab = document.querySelector('.tab-pane.active');
      
      const printContent = `
        <html>
        <head>
          <title>${title} - Governo de Minas Gerais</title>
          <style>
            body { 
              font-family: Arial, sans-serif; 
              padding: 20px; 
              color: #333; 
            }
            .print-header {
              text-align: center;
              margin-bottom: 30px;
              border-bottom: 2px solid #B93C42;
              padding-bottom: 20px;
            }
            .print-title {
              color: #29435A;
              font-size: 24px;
              margin: 0;
            }
            .print-subtitle {
              color: #666;
              font-size: 14px;
              margin: 5px 0 0 0;
            }
            .print-date {
              color: #666;
              font-size: 12px;
              margin-top: 10px;
            }
            table {
              width: 100%;
              border-collapse: collapse;
              margin: 20px 0;
              font-size: 12px;
            }
            th {
              background-color: #f8f9fa;
              color: #29435A;
              font-weight: bold;
              text-transform: uppercase;
              padding: 12px 8px;
              border: 1px solid #dee2e6;
              text-align: left;
            }
            td {
              padding: 10px 8px;
              border: 1px solid #dee2e6;
            }
            .total-row {
              background-color: #f8f9fa;
              font-weight: bold;
            }
            @media print {
              .no-print { display: none; }
              .page-break { page-break-before: always; }
            }
          </style>
        </head>
        <body>
          <div class="print-header">
            <h1 class="print-title">${title}</h1>
            <p class="print-subtitle">Governo do Estado de Minas Gerais</p>
            <p class="print-subtitle">Painel de Voos Oficiais - Dados do GitHub</p>
            <p class="print-date">Data da impressão: ${new Date().toLocaleDateString('pt-BR')}</p>
            <p class="print-date">Fonte: GitHub/${GITHUB_REPO}/${GITHUB_DATA_PATH}</p>
          </div>
          ${activeTab.innerHTML}
        </body>
        </html>
      `;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(printContent);
      printWindow.document.close();
      
      printWindow.onload = () => {
        setTimeout(() => {
          printWindow.print();
          printWindow.close();
        }, 500);
      };
    }
    
    console.log('Painel de Voos Oficiais com integração GitHub carregado com sucesso!');
  </script>
</body>
</html>
